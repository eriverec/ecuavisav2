<script setup>
import { useUserListStore } from "@/views/apps/user/useUserListStore";
import UserTabUbicacion from '@/views/dashboards/traceability/UserTabUbicacion.vue';
import { hexToRgb } from '@layouts/utils';
import VueApexCharts from 'vue3-apexcharts';
import { useTheme } from 'vuetify';
// import UserTabDispositivos from '@/views/dashboards/traceability/UserTabDispositivos.vue';
import UserTabNavegacion from '@/views/dashboards/traceability/UserTabNavegacion.vue';
import CrmProjectStatus from '@/views/dashboards/crm/CrmProjectStatus.vue';
import CrmSalesAreaCharts from '@/views/dashboards/crm/CrmSalesAreaCharts.vue';
import Moment from 'moment';
import { extendMoment } from 'moment-range';
import esLocale from "moment/locale/es";
import { onMounted, onUnmounted, ref } from "vue";
import axios from 'axios';

const moment = extendMoment(Moment);
moment.locale('es', [esLocale]);

const userListStore = useUserListStore();
const totalUsers = ref(0);
const totalAppUsers = ref(0);

const totalDevicesUser = ref(0);
const totalDevicesEmail = ref(0);
const totalDevicesFacebook = ref(0);
const totalDevicesGoogle = ref(0);
const totalDevicesApple = ref(0);

const totalFacebook = ref(0);
const totalGoogle = ref(0);
const totalEmail = ref(0);
const totalApple = ref(0);

const totalAppFacebook = ref(0);
const totalAppGoogle = ref(0);
const totalAppEmail = ref(0);
const totalAppApple = ref(0);

const percentEmail = ref(0);
const percentFacebook = ref(0);
const percentGoogle = ref(0);
const percentApple = ref(0);

const percentAppEmail = ref(0);
const percentAppFacebook = ref(0);
const percentAppGoogle = ref(0);
const percentAppApple = ref(0);

const dataChart = ref([]);
const dataDevice = ref([]);
const dataMetadato = ref([]);
const dataSection = ref([]);
const dataGeneral = ref([]);
const totalPagesVisits = ref(0);

const isLoading = ref(true);

// 👉 Fetching users

const horaVariable1 = '15:16:34';
const horaAct = moment().format('HH:mm:ss'); // Hora actual
const resultadoResta = restarHoras(horaVariable1, horaAct);
// Función para restar horas
function restarHoras(hora1, hora2) {
  const formato = 'HH:mm:ss';
  const diff = moment(hora2, formato).diff(moment(hora1, formato));
  const duracion = moment.utc(diff);
  let resultado = '';

  const horas = duracion.hours();
  if (horas > 0) {
    resultado += `${horas} ${horas === 1 ? 'hora' : 'horas'}`;
  }

  const minutos = duracion.minutes();
  if (minutos > 0 && horas > 0) {
    // resultado += ` y ${minutos} ${minutos === 1 ? 'minuto' : 'minutos'}`;
    resultado += '';

  } else if (minutos > 0) {
    resultado += `${minutos} ${minutos === 1 ? 'minuto' : 'minutos'}`;
  }

  if (resultado === '') {
    resultado = 'menos de un minuto'; // O cualquier otro mensaje que desees
  }

  // const resultado = moment.utc(diff).format(formato);
  return resultado.trim();
}
async function accionBackoffice() {
  let dateNow = moment().format("DD/MM/YYYY HH:mm:ss").toString();
  let userData = JSON.parse(localStorage.getItem('userData'));
  if (userData.email !== 'admin@demo.com') {
    var myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");
    var log = JSON.stringify({
      "usuario": userData.email,
      "pagina": "dashboard",
      "fecha": dateNow
    });
    var requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: log,
      redirect: 'follow'
    };
    await fetch(`https://servicio-logs.vercel.app/accion`, requestOptions)
      .then(response => {
      }).catch(error => console.log('error', error));
  }
}

// data de cards superiores
const countUsers = () => {
  userListStore
    .countUsers()
    .then((response) => {
      const pE = ref(0);
      const pF = ref(0);
      const pG = ref(0);
      const pA = ref(0);

      const pAppE = ref(0);
      const pAppF = ref(0);
      const pAppG = ref(0);
      const pAppA = ref(0);

      totalUsers.value = (response.data.totalEmail) + (response.data.totalFacebook) + (response.data.totalGoogle) + (response.data.totalApple);
      totalEmail.value = response.data.totalEmail;
      totalFacebook.value = response.data.totalFacebook;
      totalGoogle.value = response.data.totalGoogle;
      totalApple.value = response.data.totalApple;

      //DATOS DE APP
      totalAppUsers.value = (response.data.totalAppEmail) + (response.data.totalAppGoogle) + (response.data.totalAppFacebook) + (response.data.totalAppApple);
      totalAppEmail.value = response.data.totalAppEmail;
      totalAppFacebook.value = response.data.totalAppFacebook;
      totalAppGoogle.value = response.data.totalAppGoogle;
      totalAppApple.value = response.data.totalAppApple;

      let total = totalUsers.value;

      let totalApp = totalAppUsers.value;

      totalDevicesUser.value = (response.data.totalEmail) + (response.data.totalFacebook) + (response.data.totalGoogle) + (totalApp);
      totalDevicesEmail.value = (response.data.totalEmail) + (response.data.totalAppEmail);
      totalDevicesFacebook.value = (response.data.totalFacebook) + (response.data.totalAppFacebook);
      totalDevicesGoogle.value = (response.data.totalGoogle) + (response.data.totalAppGoogle);
      totalDevicesApple.value = (response.data.totalApple) + (response.data.totalAppApple);

      pE.value = (totalEmail.value * 100) / total;
      percentEmail.value = Math.round((pE.value + Number.EPSILON) * 100) / 100;

      pF.value = (totalFacebook.value * 100) / total;
      percentFacebook.value = Math.round((pF.value + Number.EPSILON) * 100) / 100;

      pG.value = (totalGoogle.value * 100) / total;
      percentGoogle.value = Math.round((pG.value + Number.EPSILON) * 100) / 100;

      pA.value = (totalApple.value * 100) / total;
      percentApple.value = Math.round((pA.value + Number.EPSILON) * 100) / 100;

      //DATOS DE APP
      pAppE.value = (totalAppEmail.value * 100) / totalApp;
      percentAppEmail.value = Math.round((pAppE.value + Number.EPSILON) * 100) / 100;

      pAppF.value = (totalAppFacebook.value * 100) / totalApp;
      percentAppFacebook.value = Math.round((pAppF.value + Number.EPSILON) * 100) / 100;

      pAppG.value = (totalAppGoogle.value * 100) / totalApp;
      percentAppGoogle.value = Math.round((pAppG.value + Number.EPSILON) * 100) / 100;

      pAppA.value = (totalAppApple.value * 100) / totalApp;
      percentAppApple.value = Math.round((pAppA.value + Number.EPSILON) * 100) / 100;

      isLoading.value = false;

      accionBackoffice();

    })
    .catch((error) => {
      console.error(error);
    });
};
const route = useRoute()
const userData = ref()
const userTab = ref(null)

userListStore.fetchUser(Number(route.params.id)).then(response => {
  userData.value = response.data
})

countUsers();
const userListMeta = [
  {
    icon: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 1rem; height: 1rem;" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><path fill="#7367f0" d="M12 4a4 4 0 0 1 4 4a4 4 0 0 1-4 4a4 4 0 0 1-4-4a4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4Z"/></svg>',
    color: "primary",
    title: "Total de Usuarios",
    stats: totalUsers,
    percentage: null,
    percentageApp: null,
    subtitle: totalAppUsers,
    total: totalDevicesUser
  },

  {
    icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 33.39 14" width="1rem" height="1rem"><g id="Capa_2" data-name="Capa 2"><g id="logo"><path d="M14.19,12.16a1.66,1.66,0,0,0-1.66-1.66H1.66a1.66,1.66,0,0,0,0,3.32H12.53A1.66,1.66,0,0,0,14.19,12.16Z" style="fill:#7367f0"/><path d="M32.52.19a1.68,1.68,0,0,0-2.25.68L25.09,9.14,20.23.77A1.72,1.72,0,0,0,18.77.08H7.82a1.66,1.66,0,0,0,0,3.32h9.53a1,1,0,0,1,.78.36l5.39,9.3a1.71,1.71,0,0,0,.71.75,1.66,1.66,0,0,0,2.25-.68L33.19,2.44A1.67,1.67,0,0,0,32.52.19Z" style="fill:#7367f0"/><path d="M19.25,13.83a1.65,1.65,0,0,0,.79-2.2s-2.38-4-3.24-5.74a1.12,1.12,0,0,0-1-.63H4.48a1.66,1.66,0,0,0,0,3.32H14a.65.65,0,0,1,.58.29C15.41,10.55,17,13,17,13.05A1.65,1.65,0,0,0,19.25,13.83Z" style="fill:#7367f0"/></g></g></svg>',
    color: "error",
    title: "Total con Email",
    stats: totalEmail,
    percentage: percentEmail,
    percentageApp: percentAppEmail,
    subtitle: totalAppEmail,
    total: totalDevicesEmail
  },
  {
    icon: '<svg width="1rem" height="1rem" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M18 9C18 4.02944 13.9706 0 9 0C4.02944 0 0 4.02944 0 9C0 13.4922 3.29117 17.2155 7.59375 17.8906V11.6016H5.30859V9H7.59375V7.01719C7.59375 4.76156 8.9374 3.51562 10.9932 3.51562C11.9779 3.51562 13.0078 3.69141 13.0078 3.69141V5.90625H11.8729C10.7549 5.90625 10.4062 6.6 10.4062 7.31175V9H12.9023L12.5033 11.6016H10.4062V17.8906C14.7088 17.2155 18 13.4922 18 9Z" fill="#1877F2"/></svg>',
    color: "success",
    title: "Total con Facebook",
    stats: totalFacebook,
    percentage: percentFacebook,
    percentageApp: percentAppFacebook,
    subtitle: totalAppFacebook,
    total: totalDevicesFacebook
  },
  {
    icon: '<svg aria-hidden="true" class="native svg-icon iconGoogle" width="1rem" height="1rem" viewBox="0 0 18 18"><path d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18Z" fill="#4285F4"></path><path d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17Z" fill="#34A853"></path><path d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07Z" fill="#FBBC05"></path><path d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3Z" fill="#EA4335"></path></svg>',
    color: "warning",
    title: "Total con Google",
    stats: totalGoogle,
    percentage: percentGoogle,
    percentageApp: percentAppGoogle,
    subtitle: totalAppGoogle,
    total: totalDevicesGoogle
  },
  {
    icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1rem" height="1rem"><path d="M11.6734 7.2221C10.7974 7.2221 9.44138 6.2261 8.01338 6.2621C6.12938 6.2861 4.40138 7.3541 3.42938 9.0461C1.47338 12.4421 2.92538 17.4581 4.83338 20.2181C5.76938 21.5621 6.87338 23.0741 8.33738 23.0261C9.74138 22.9661 10.2694 22.1141 11.9734 22.1141C13.6654 22.1141 14.1454 23.0261 15.6334 22.9901C17.1454 22.9661 18.1054 21.6221 19.0294 20.2661C20.0974 18.7061 20.5414 17.1941 20.5654 17.1101C20.5294 17.0981 17.6254 15.9821 17.5894 12.6221C17.5654 9.8141 19.8814 8.4701 19.9894 8.4101C18.6694 6.4781 16.6414 6.2621 15.9334 6.2141C14.0854 6.0701 12.5374 7.2221 11.6734 7.2221ZM14.7934 4.3901C15.5734 3.4541 16.0894 2.1461 15.9454 0.850098C14.8294 0.898098 13.4854 1.5941 12.6814 2.5301C11.9614 3.3581 11.3374 4.6901 11.5054 5.9621C12.7414 6.0581 14.0134 5.3261 14.7934 4.3901Z" fill="rgba(0,0,0,1)"></path></svg>`,
    color: "warning",
    title: "Total con Apple",
    stats: totalApple,
    percentage: percentApple,
    percentageApp: percentAppApple,
    subtitle: totalAppApple,
    total: totalDevicesApple
  },
];
// Fin data de cards superiores

/* */
// 👉 Colors variables
const colorVariables = themeColors => {
  const themeSecondaryTextColor = `rgba(${hexToRgb(themeColors.colors['on-surface'])},${themeColors.variables['medium-emphasis-opacity']})`
  const themeDisabledTextColor = `rgba(${hexToRgb(themeColors.colors['on-surface'])},${themeColors.variables['disabled-opacity']})`
  const themeBorderColor = `rgba(${hexToRgb(String(themeColors.variables['border-color']))},${themeColors.variables['border-opacity']})`
  const themePrimaryTextColor = `rgba(${hexToRgb(themeColors.colors['on-surface'])},${themeColors.variables['high-emphasis-opacity']})`

  return { themeSecondaryTextColor, themeDisabledTextColor, themeBorderColor, themePrimaryTextColor }
}

const vuetifyTheme = useTheme();

const { themeBorderColor, themeDisabledTextColor } = colorVariables(vuetifyTheme.current.value);

const resolveData = computed(() => {

  let dataRaw = Array.from(dataChart.value);
  const seriesFormat = {
    name: 'Interacciones de usuarios',
    data: []
  };

  const categoriesRaw = [];
  for (let i in dataRaw) {
    let num = parseInt(dataRaw[i].visits);
    seriesFormat.data.push(num);
    categoriesRaw.push(dataRaw[i].title);
  }

  const options = {
    chart: {
      parentHeightOffset: 0,
      toolbar: { show: false },
      height: (seriesFormat.data.length > 0 && seriesFormat.data.length < 6) ? 600 : 700
    },
    dataLabels: {
      enabled: true
    },
    legend: {
      position: 'top',
      horizontalAlign: 'left',
      offsetX: 40,
      show: false
    },
    colors: ['#d4526e', '#13d8aa'],
    plotOptions: {
      bar: {
        borderRadius: 0,
        barHeight: '70%',
        horizontal: true,
        distributed: true,
        startingShape: 'rounded',
      },
    },
    // title: {
    //   text: 'Visitas por Páginas',
    //   style: {
    //     fontSize: '16px',
    //     fontWeight: 'bold',
    //     fontFamily: undefined,
    //     color: themeDisabledTextColor
    //   },
    // },
    grid: {
      borderColor: themeBorderColor,
      xaxis: {
        lines: { show: true },
      },
      padding: {
        top: -10,
      },
    },
    yaxis: {
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    xaxis: {
      axisBorder: { show: false },
      axisTicks: { color: themeBorderColor },
      categories: categoriesRaw,
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    minHeight: 300,
  }
  return { series: [seriesFormat], options: options, intereses: categoriesRaw };
});

const resolveDevice = computed(() => {

  let dataRaw = Array.from(dataDevice.value);
  const seriesFormat = {
    name: 'Device',
    data: []
  };

  const categoriesRaw = [];
  for (let i in dataRaw) {
    let num = parseInt(dataRaw[i].visits);
    seriesFormat.data.push(num);
    categoriesRaw.push(dataRaw[i].name);
  }

  const options = {
    chart: {
      // type: 'pie',
      // parentHeightOffset: 0,
      // toolbar: { show: false },
      // height: 400
    },
    dataLabels: {
      enabled: true,
      style: {
        fontSize: '16px',
        fontFamily: 'Helvetica, Arial, sans-serif',
        fontWeight: 'bold',
        colors: ['#fff']
      },
    },
    legend: {
      position: 'bottom',
      horizontalAlign: 'left',
      offsetX: 40,
      show: true,
      labels: {
        colors: themeDisabledTextColor,
        useSeriesColors: false
      },
    },
    // plotOptions: {},
    // title: {
    //   text: 'Visitas por Dispositivos',
    //   align: 'center',
    //   style: {
    //     fontSize: '16px',
    //     fontWeight: 'bold',
    //     fontFamily: 'Helvetica, Arial, sans-serif',
    //     color: themeDisabledTextColor
    //   },
    // },
    yaxis: {
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    colors: ['#33b2df', '#546E7A'],
    labels: categoriesRaw,
  }
  return { series: seriesFormat.data, options: options };
});

const resolveMetadato = computed(() => {

  let dataRaw = Array.from(dataMetadato.value);
  const seriesFormat = {
    name: 'Metadato',
    data: []
  };

  const categoriesRaw = [];
  for (let i in dataRaw) {
    let num = parseInt(dataRaw[i].visits);
    seriesFormat.data.push(num);
    categoriesRaw.push(dataRaw[i].name);
  }

  const options = {
    chart: {
      parentHeightOffset: 0,
      toolbar: { show: false },
      height: (seriesFormat.data.length > 0 && seriesFormat.data.length < 6) ? 400 : 700
    },
    dataLabels: {
      enabled: true
    },
    legend: {
      position: 'top',
      horizontalAlign: 'left',
      offsetX: 40,
      show: false
    },
    plotOptions: {
      bar: {
        borderRadius: 0,
        barHeight: '70%',
        horizontal: true,
        distributed: true,
        startingShape: 'rounded',
      },
    },
    grid: {
      borderColor: themeBorderColor,
      xaxis: {
        lines: { show: true },
      },
      padding: {
        top: -10,
      },
    },
    // title: {
    //   text: 'Visitas por Metadatos',
    //   style: {
    //     fontSize: '16px',
    //     fontWeight: 'bold',
    //     fontFamily: undefined,
    //     color: themeDisabledTextColor
    //   },
    // },
    yaxis: {
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    colors: ['#A5978B', '#2b908f'],
    xaxis: {
      axisBorder: { show: false },
      axisTicks: { color: themeBorderColor },
      categories: categoriesRaw,
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    minHeight: 300,
  }
  return { series: [seriesFormat], options: options, intereses: categoriesRaw };
});

const resolveSection = computed(() => {

  let dataRaw = Array.from(dataSection.value);
  const seriesFormat = {
    name: 'Seccion',
    data: []
  };

  const categoriesRaw = [];
  for (let i in dataRaw) {
    let num = parseInt(dataRaw[i].visits);
    seriesFormat.data.push(num);
    categoriesRaw.push(dataRaw[i].name);
  }

  const options = {
    chart: {
      parentHeightOffset: 0,
      toolbar: { show: false },
      height: (seriesFormat.data.length > 0 && seriesFormat.data.length < 6) ? 400 : 700
    },
    dataLabels: {
      enabled: true
    },
    legend: {
      position: 'top',
      horizontalAlign: 'left',
      offsetX: 40,
      show: false
    },
    plotOptions: {
      bar: {
        borderRadius: 0,
        barHeight: '70%',
        horizontal: true,
        distributed: true,
        startingShape: 'rounded',
      },
    },
    grid: {
      borderColor: themeBorderColor,
      xaxis: {
        lines: { show: true },
      },
      padding: {
        top: -10,
      },
    },
    // title: {
    //   text: 'Visitas por Secciones',
    //   style: {
    //     fontSize: '16px',
    //     fontWeight: 'bold',
    //     fontFamily: undefined,
    //     color: themeDisabledTextColor
    //   },
    // },
    yaxis: {
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    colors: ['#f48024', '#69d2e7'],
    xaxis: {
      axisBorder: { show: false },
      axisTicks: { color: themeBorderColor },
      categories: categoriesRaw,
      labels: {
        style: { colors: themeDisabledTextColor },
      },
    },
    minHeight: 300,
  }
  return { series: [seriesFormat], options: options, intereses: categoriesRaw };
});

const chartSeries = ref([]);
const chartOptions = ref({
  chart: {
    parentHeightOffset: 0,
    toolbar: { show: false },
    height: 400,
  },

  dataLabels: { enabled: true },
  legend: { position: 'top', horizontalAlign: 'left', offsetX: 40, show: false },
  plotOptions: { bar: { horizontal: true, startingShape: 'rounded' } },
  grid: { borderColor: '#e0e0e0', padding: { top: -10 } },
  yaxis: { labels: { style: { colors: '#888' } } },
  colors: ['#f48024'],
  xaxis: { type: 'datetime', labels: { style: { colors: '#888' } } },
  minHeight: 300,
});

onMounted(async () => {
  // try {
  //   const response = await axios.get('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?groupTime=10');
  //   const apiData = response.data;
  //   console.log(apiData);

  //   const seriesData = Object.entries(apiData).map(([timestamp, value]) => [new Date(timestamp).getTime(), value]);

  //   chartSeries.value = [{ name: 'Seccion', data: seriesData }];
  // } catch (error) {
  //   console.error('Error fetching data:', error);
  // }
});

// const resolveGeneral = computed(() => {

//   let dataRaw = Array.from(dataGeneral.value);
//   const seriesFormat = {
//     name: 'Seccion',
//     data: []
//   };

//   const categoriesRaw = [];
//   for (let i in dataRaw) {
//     let num = parseInt(dataRaw[i].visits);
//     seriesFormat.data.push(num);
//     categoriesRaw.push(dataRaw[i].name);
//   }

//   const options = {
//     chart: {
//       parentHeightOffset: 0,
//       toolbar: { show: false },
//       height: (seriesFormat.data.length > 0 && seriesFormat.data.length < 6) ? 400 : 700
//     },
//     dataLabels: {
//       enabled: true
//     },
//     legend: {
//       position: 'top',
//       horizontalAlign: 'left',
//       offsetX: 40,
//       show: false
//     },
//     plotOptions: {
//       bar: {
//         borderRadius: 0,
//         barHeight: '70%',
//         horizontal: true,
//         distributed: true,
//         startingShape: 'rounded',
//       },
//     },
//     grid: {
//       borderColor: themeBorderColor,
//       xaxis: {
//         lines: { show: true },
//       },
//       padding: {
//         top: -10,
//       },
//     },
//     yaxis: {
//       labels: {
//         style: { colors: themeDisabledTextColor },
//       },
//     },
//     colors: ['#f48024', '#69d2e7'],
//     xaxis: {
//       axisBorder: { show: false },
//       axisTicks: { color: themeBorderColor },
//       categories: categoriesRaw,
//       labels: {
//         style: { colors: themeDisabledTextColor },
//       },
//     },
//     minHeight: 300,
//   }
//   return { series: [seriesFormat], options: options, intereses: categoriesRaw };
// });


// realtimme procesos 
const entriesLength = ref(false);
const deviceLength = ref(false);
const metadatoLength = ref(false);
const sectionLength = ref(false);

const isListVisible = ref(false);
const registers = ref([])
const realtime = ref(false)
let intervalId = null
const entries = ref([]);
const totalVisits = ref(0);
const sumV = ref(0);


// Grafico general tiempo
const fetchGeneral = async () => {
  // const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?groupTime=10')
  // const data = await response.json();
  // dataGeneral.value = data;

  const response = await axios.get('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?groupTime=10');
  const apiData = response.data;
  dataGeneral.value = apiData;

  // console.log(apiData);

  const seriesData = Object.entries(apiData).map(([timestamp, value]) => {
    const time = timestamp.split(' ')[1];
    const [hour, minute] = time.split(':');
    const timestampInMilliseconds = new Date(0, 0, 0, hour, minute).getTime();
    return [timestampInMilliseconds, value];
  });
  chartSeries.value = [{ name: 'Seccion', data: seriesData }];

  // console.log(seriesData);


  // [moment(timestamp).format('HH:mm'), value]);
  // {

  //   var fecha = new Date(timestamp);
  //   var hora = fecha.getHours();
  //   var minutos = fecha.getMinutes();

  //   // Formatear la hora y minutos según tus necesidades
  //   var horaFormateada = hora < 10 ? "0" + hora : hora;
  //   var minutosFormateados = minutos < 10 ? "0" + minutos : minutos;

  //   var horaCompleta = horaFormateada + ":" + minutosFormateados;
  //   console.log(horaCompleta);
  //   return horaCompleta
  //   // [new Date(horaCompleta).getTime(), value]

  // });




  // if (dataDevice.value.length > 0) {
  //   deviceLength.value = true;
  // }
}


// Grafico Devise
const fetchDevice = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?device')
  const data = await response.json();
  dataDevice.value = data.slice(0, 10);
  if (dataDevice.value.length > 0) {
    deviceLength.value = true;
  }
}

const fetchConteov2 = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?groupUsers')
  const data = await response.json();
  sumV.value = data.length;
}

function contarSecuencial(inicio, fin, tiempoTotal) {
  const intervalo = tiempoTotal / Math.abs(fin - inicio);
  const incremento = inicio < fin ? 1 : -1;
  let contador = inicio;

  const realizarConteo = () => {
    // sumV.value = contador;

    if ((incremento > 0 && contador < fin) || (incremento < 0 && contador > fin)) {
      contador += incremento;
      setTimeout(realizarConteo, intervalo);
    }
  };

  realizarConteo();
}

const fetchEntries = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?grouped=10')
  const data = await response.json()
  entries.value = data;
  dataChart.value = data.slice(0, 10);
  const ty = (entries.value).map((item) => (
    totalVisits.value = JSON.parse(item.visits)
  ));
  var totalTemSumV = ty.reduce((acc, item) => acc + item, 0);

  if (sumV.value !== totalTemSumV) {
    // contarSecuencial(sumV.value, totalTemSumV, 2000);
  }

  // totalPagesVisits.value = data.reduce((total, item) => total + item.visits, 0);

  // console.log(data)

  // sumV.value = ty.reduce((acc, item) => acc + item, 0);
  // console.log(sumV.value);
  if (dataChart.value.length > 0) {
    entriesLength.value = true;
  }
}

// Grafico Metadatos
const fetchMetadato = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?metadato')
  const data = await response.json();
  dataMetadato.value = data.slice(0, 10);
  // console.log(dataMetadato.value);
  if (dataMetadato.value.length > 0) {
    metadatoLength.value = true;
  }
}

// Grafico Section
const fetchSection = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?section')
  const data = await response.json();
  dataSection.value = data.slice(0, 10);
  // console.log(dataMetadato.value);
  if (dataMetadato.value.length > 0) {
    sectionLength.value = true;
  }
}

const fetchRegisters = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/show_v_3.php?entries')
  const data = await response.json()
  registers.value = data;
}

const resetEntries = async () => {
  const response = await fetch('https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/reset.php')
  // const data = await response.json()
  console.log("se reseteó el módulo correctamente")
}
// const toggleRealtime = () => {
//   realtime.value = !realtime.value
//   if (realtime.value) {
//     intervalId = setInterval(fetchEntries, 5000)
//   } else {
//     clearInterval(intervalId)
//   }
// }

const toggleRealtime = () => {
  realtime.value = !realtime.value;
  isListVisible.value = !isListVisible.value; // nuevo
  if (realtime.value) {
    function juntas() {
      fetchEntries(); // nuevo
      fetchDevice();
      fetchMetadato();
      fetchSection();
      // fetchGeneral();
      fetchConteov2();
      // fetchRegisters(); // nuevo

    }
    intervalId = setInterval(juntas, 3500);
  } else {
    resetEntries();
    clearInterval(intervalId);
  }
};




onUnmounted(() => {
  clearInterval(intervalId)
})

const goToLink = (link) => {
  window.open(link, '_blank');
};

// return { entries, toggleRealtime }
// fin  realtime adicionado

</script>



<style>
@media screen and (max-width: 1500px) and (min-width: 1280px) {
  .tarjeta {
    width: 185px;
  }

  .tarjeta svg {
    display: none;
  }
}

@media screen and (max-width: 3000px) and (min-width: 1501px) {
  .tarjeta {
    width: 215px;
  }

}

@media screen and (max-width: 600px) and (min-width: 300px) {

  #dash .v-card-title {
    font-size: 18px;
  }


}



#navegacion .v-card-text {
  padding: 0px;
}

.botonescurrentPage {
  padding: 20px;
}


/*#realtime .v-card-item {
  padding: 1px;
}


#realtime .v-list-item-title {
  font-size: 13px;
}



.switch {
  margin-left: 20px;
  margin-bottom: 5px;
}*/

.text-sum {
  font-size: 75px;
  font-weight: bold;
  letter-spacing: 2px;
}
</style>



<template>
  <section>
    <VRow>
      <VCol class="mr-6" v-for="meta in userListMeta" :key="meta.title" cols="12" sm="12" lg="2">


        <VCard class="col-12 col-sm- col-lg-2 tarjeta">
          <VCardText class="d-flex justify-space-between" style="font-size:11px;">
            <div>
              <span>{{ meta.title }}</span>
              <div>
                <div class="d-flex align-center gap-2 my-1">
                  <svg xmlns="http://www.w3.org/2000/svg" color="#7367F0" width="18" height="18" viewBox="0 0 256 256">
                    <path fill="currentColor"
                      d="M245.11 60.68c-7.65-13.19-27.84-16.16-58.5-8.66A95.93 95.93 0 0 0 32 128a98 98 0 0 0 .78 12.31C5.09 169 5.49 186 10.9 195.32C16 204.16 26.64 208 40.64 208a124.11 124.11 0 0 0 28.79-4A95.93 95.93 0 0 0 224 128a97.08 97.08 0 0 0-.77-12.25c12.5-13 20.82-25.35 23.65-35.92c1.95-7.32 1.36-13.76-1.77-19.15ZM128 48a80.11 80.11 0 0 1 78 62.2c-17.06 16.06-40.15 32.53-62.07 45.13c-27.55 15.81-51.45 25.67-70.51 31.07A79.94 79.94 0 0 1 128 48ZM24.74 187.29c-1.46-2.51-.65-7.24 2.22-13a79.05 79.05 0 0 1 10.29-15.05a96 96 0 0 0 18 31.32c-17.25 2.9-28.01 1.05-30.51-3.27ZM128 208a79.45 79.45 0 0 1-38.56-9.94a370 370 0 0 0 62.43-28.86c21.58-12.39 40.68-25.82 56.07-39.08A80.07 80.07 0 0 1 128 208ZM231.42 75.69c-1.7 6.31-6.19 13.53-12.63 21.13a95.69 95.69 0 0 0-18-31.35c14.21-2.35 27.37-2.17 30.5 3.24c.9 1.57.95 3.92.13 6.98Z" />
                  </svg>
                  <!-- Ícono para "Web" -->
                  <label class="text-primary">Web:</label> {{ meta.stats }}
                  <span class="text-success" :hidden="meta.percentage ? false : true">({{ meta.percentage }}%) </span>
                </div>
                <div class="d-flex align-center gap-2 my-1">
                  <svg xmlns="http://www.w3.org/2000/svg" color="#7367F0" width="18" height="18" viewBox="0 0 24 24">
                    <path fill="currentColor"
                      d="m17.578 4.432l-2-1.05C13.822 2.461 12.944 2 12 2s-1.822.46-3.578 1.382l-.321.169l8.923 5.099l4.016-2.01c-.646-.732-1.688-1.279-3.462-2.21Zm4.17 3.532l-3.998 2V13a.75.75 0 0 1-1.5 0v-2.287l-3.5 1.75v9.441c.718-.179 1.535-.607 2.828-1.286l2-1.05c2.151-1.129 3.227-1.693 3.825-2.708c.597-1.014.597-2.277.597-4.8v-.117c0-1.893 0-3.076-.252-3.978ZM11.25 21.904v-9.44l-8.998-4.5C2 8.866 2 10.05 2 11.941v.117c0 2.525 0 3.788.597 4.802c.598 1.015 1.674 1.58 3.825 2.709l2 1.049c1.293.679 2.11 1.107 2.828 1.286ZM2.96 6.641l9.04 4.52l3.411-1.705l-8.886-5.078l-.103.054c-1.773.93-2.816 1.477-3.462 2.21Z" />
                  </svg>
                  <!-- Ícono para "App" -->
                  <label class="text-primary">App:</label> {{ meta.subtitle }} <span class="text-success"
                    :hidden="meta.percentageApp ? false : true">({{ meta.percentageApp }}%) </span>
                </div>
                <div class="d-flex align-center gap-2 my-1">
                  <svg xmlns="http://www.w3.org/2000/svg" color="#7367F0" width="18" height="18" viewBox="0 0 26 26">
                    <path fill="currentColor"
                      d="M12.906-.031a1 1 0 0 0-.125.031A1 1 0 0 0 12 1v1H3a3 3 0 0 0-3 3v13c0 1.656 1.344 3 3 3h9v.375l-5.438 2.719a1.006 1.006 0 0 0 .875 1.812L12 23.625V24a1 1 0 1 0 2 0v-.375l4.563 2.281a1.006 1.006 0 0 0 .875-1.812L14 21.375V21h9c1.656 0 3-1.344 3-3V5a3 3 0 0 0-3-3h-9V1a1 1 0 0 0-1.094-1.031zM2 5h22v13H2V5zm18.875 1a1 1 0 0 0-.594.281L17 9.563L14.719 7.28a1 1 0 0 0-1.594.219l-2.969 5.188l-1.219-3.063a1 1 0 0 0-1.656-.344l-3 3a1.016 1.016 0 1 0 1.439 1.44l1.906-1.906l1.438 3.562a1 1 0 0 0 1.812.125l3.344-5.844l2.062 2.063a1 1 0 0 0 1.438 0l4-4A1 1 0 0 0 20.875 6z" />
                  </svg>
                  <!-- Ícono para "Total" -->
                  <label class="text-primary">Total:</label> {{ meta.total }}
                </div>
              </div>
            </div>
            <VAvatar rounded variant="tonal" :color="meta.color" v-html="meta.icon" max-width="100%" />

          </VCardText>
        </VCard>

      </VCol>
    </VRow>
    <!--<VCardText class="px-0 d-none" v-if="isListVisible.valueOf">
            <VList lines="two" border>
              <template v-for="(register, index) in registers" :key="register.title">

                <VListItem>
                  <VListItemTitle>
                    {{ register.title }}
                  </VListItemTitle>
                  <VListItemSubtitle class="mt-1">
                    <span class="text-xs">Id de Usuario: {{ register.userId }}</span>
                    <span class="text-xs"></span>
                    <VChip class="mx-2" color="success">hace {{ restarHoras(register.hora, horaAct) }}</VChip>

                  </VListItemSubtitle>

                  <template #append>
                    <VBtn size="small" @click="goToLink(register.url)">
                      <VIcon icon="mdi-link-variant" />
                    </VBtn>
                  </template>
                </VListItem>
                <VDivider v-if="index !== register.length - 1" />
              </template>
            </VList>
          </VCardText> -->
    <VRow id="dash">
      <!-- 👉 Project Status -->
      <!-- <VCol
      cols="12"
      md="7"
    >
      <CrmProjectStatus />
    </VCol>

    <VCol
      cols="12"
      md="12"
      sm="5"
      lg="5"
    >
      <CrmSalesAreaCharts />
    </VCol> -->

      <!-- Columna de Navegación & Realtimee -->
      <VCol class="d-flex" id="navegacion" cols="12" sm="6">
        <UserTabNavegacion />

      </VCol>

      <!-- Columna de Ubicaciones -->
      <VCol class="d-flex" cols="12" sm="6">
        <UserTabUbicacion />
      </VCol>

      <!-- Columna de Realtime -->
      <VCol class="d-flex" id="realtime" cols="12" sm="6">

        <VCard class="px-4 py-4 v-col-12">
          <VCardItem class="header_card_item pb-4">
            <div class="d-flex pr-0" style="justify-content: space-between;">
              <div class="descripcion" cols="12" sm="6">
                <VCardTitle>Visitas de usuarios registrados en tiempo real</VCardTitle>
                <VCardSubtitle cols="12">Tiempo de actualización: 30 segundos
                </VCardSubtitle>
              </div>
              <div class="pt-5 pr-3">
                <VSwitch class="mt-n4 " v-model="realtime" @click="toggleRealtime"></VSwitch>
              </div>

            </div>
          </VCardItem>
          <VCardText class="px-0" v-if="isListVisible.valueOf">


            <VList v-if="entriesLength" lines="two" border class="BORDER--">
              <template v-for="(entry, index) in entries" :key="entry.title">
                <VListItem>
                  <VListItemTitle>
                    {{ entry.title }}
                  </VListItemTitle>
                  <VListItemSubtitle class="mt-1">
                    <!-- <VBadge
                        dot
                        location="start center"
                        offset-x="2"
                        :color="resolveStatusColor[user.status]"
                        class="me-3"
                      >
                        <span class="ms-4">{{ user.status }}</span>
                      </VBadge> -->

                    <span class="text-xs">Visitas: {{ entry.visits }}</span>
                  </VListItemSubtitle>

                  <template #append>
                    <VBtn size="small" @click="goToLink(entry.url)">
                      <VIcon icon="mdi-link-variant" />
                    </VBtn>
                  </template>
                </VListItem>
                <VDivider v-if="index !== entries.length - 1" />
              </template>
            </VList>

            <div v-else></div>


          </VCardText>
        </VCard>
      </VCol>

      <!--Columna de Registros de muestreo-->

      <VCol class="dere__" id="realtime" cols="12" sm="6">

        <VRow>
          <VCol cols="12" sm="12" class="">
            <CrmProjectStatus :realtime="realtime" :usuarios="sumV" :totalPagesVisits="totalPagesVisits" />
            <!-- <VCard class="px-4 py-4 v-col-12  h-100">
              <VCardItem class="header_card_item pb-4">
                <div class="d-flex pr-5" style="justify-content: space-between;">
                  <div class="descripcion">
                    <VCardTitle>Tiempo Real - General</VCardTitle>
                  </div>

                </div>
              </VCardItem>

              <VueApexCharts v-if="sumV != 0" type="bar" :options="chartOptions" :series="chartSeries" />

            </VCard> -->
          </VCol>


          <VCol cols="12" sm="6">
            <VCard class="px-4 py-4 v-col-12  h-100">
              <VCardItem class="header_card_item pb-4">
                <div class="d-flex pr-5" style="justify-content: space-between;">
                  <div class="descripcion">
                    <VCardTitle>Tiempo Real por Dispositivos</VCardTitle>
                  </div>
                  <!-- <div class="">
                <VSwitch class="mt-n4 pt-5" disabled @click="toggleRealtime"></VSwitch>
              </div> -->

                </div>
              </VCardItem>
              <!-- <iframe src="https://estadisticas.ecuavisa.com/sites/gestor/Tools/realtimeService/pie.html" width="100%"
            height="100%" frameborder="0"></iframe> -->

              <VueApexCharts v-if="sumV != 0" type="pie" :options="resolveDevice.options"
                :series="resolveDevice.series" />



            </VCard>
          </VCol>

          <VCol cols="12" sm="6">
            <VCard class="px-4 py-4 v-col-12  h-100">
              <VCardItem class="header_card_item pb-4">
                <div class="d-flex pr-5" style="justify-content: space-between;">
                  <div class="descripcion" cols="12" sm="6">
                    <VCardTitle>Total de usuarios activos</VCardTitle>
                  </div>
                </div>
              </VCardItem>
              <div v-if="sumV != 0" class="mb-5 d-flex justify-center align-center flex-column">
                <span class="text-sum text-success"> {{ sumV }}</span>
                <span class="">Suma de los registros.</span>
              </div>

            </VCard>
          </VCol>

        </VRow>



        <VRow>
          <VCol cols="12" sm="12">
            <VCard class="px-4 py-4 v-col-12 mb-3 mt-3">
              <VCardItem class="header_card_item pb-4">
                <div class="d-flex pr-5" style="justify-content: space-between;">
                  <div class="descripcion" cols="12" sm="6">
                    <VCardTitle>Tiempo Real por Páginas</VCardTitle>
                  </div>

                </div>
              </VCardItem>
              <VueApexCharts v-if="sumV != 0" class="graficoRealTime" type="bar" :options="resolveData.options"
                :series="resolveData.series" />
            </VCard>
          </VCol>
        </VRow>




        <VRow>
          <VCol cols="12" sm="6">
            <VCard class="px-4 py-4 v-col-12 mb-5">
              <VCardItem class="header_card_item pb-4">
                <div class="d-flex pr-5" style="justify-content: space-between;">
                  <div class="descripcion" cols="12" sm="6">
                    <VCardTitle>Tiempo Real por Metadatos</VCardTitle>
                  </div>

                </div>
              </VCardItem>
              <VueApexCharts v-if="sumV != 0" type="bar" :options="resolveMetadato.options"
                :series="resolveMetadato.series" />
            </VCard>
          </VCol>

          <VCol cols="12" sm="6">
            <VCard class="px-4 py-4 v-col-12 mb-5">
              <VCardItem class="header_card_item pb-4">
                <div class="d-flex pr-5" style="justify-content: space-between;">
                  <div class="descripcion" cols="12" sm="6">
                    <VCardTitle>Tiempo Real por Secciones</VCardTitle>
                  </div>
                </div>
              </VCardItem>

              <VueApexCharts v-if="sumV != 0" type="bar" :options="resolveSection.options"
                :series="resolveSection.series" />
            </VCard>
          </VCol>

        </VRow>




      </VCol>
      <!-- <VCol class="d-flex" cols="12" sm="6">
        <div>
        Realtime
          <VSwitch v-model="realtime" @click="toggleRealtime">Desactivar Realtime</VSwitch>
          <ul>
            <li v-for="entry in entries" :key="entry.title">
              {{ entry.title }} con el número de visitas:  {{ entry.visits }}
            </li>
          </ul>
        </div>
      </VCol> -->
    </VRow>
  </section>
</template>

<script>


// export default {
// setup() {

// }
// }
</script>
