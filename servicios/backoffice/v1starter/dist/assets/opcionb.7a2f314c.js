import{R as X,U as K,r as u,Q as U,v as Z,as as ee,z as R,o as V,x as k,a as n,w as i,q as A,t as m,f as ae,e as te,h as P,b as a,aT as j,$ as se,aU as oe,aV as le,a1 as re,c as z,a3 as B,p as H,g as ne,aW as ie,F as de,C as ce,X as ue,d as pe,u as L,N as me,ao as F,ap as q,a2 as ve,V as fe}from"./index.88d3c7f5.js";import{a as _e}from"./formatters.a9a9bf7f.js";import{M as he}from"./index.50982b4e.js";import{V as be}from"./VSpacer.2a3e77c9.js";import{V as ge}from"./VPagination.9412c3b8.js";const ye=a("h1",null,"Exportaci\xF3n de usuarios que han cumplido Desaf\xEDos por Semana",-1),xe={class:"me-3 d-flex gap-4"},we={class:"app-user-search-filter d-flex align-top"},Ve=a("thead",null,[a("tr",null,[a("th",{scope:"col"},"Nombres"),a("th",{scope:"col"},"Fecha de nacimiento"),a("th",{scope:"col"},"Tel\xE9fono"),a("th",{scope:"col"},"Fecha de registro"),a("th",{scope:"col"},"Ciudad"),a("th",{scope:"col"},"Acciones")])],-1),De={key:0},Ye={class:"d-flex align-center"},ke={key:1},Me={class:"d-flex flex-column"},$e={class:"text-base"},Ee={class:"text-sm text-disabled"},Ce={class:"text-base"},Ue={class:"text-base"},Ae={class:"text-base"},Te={class:"text-base"},Ie={class:"text-center",style:{width:"5rem"}},je=a("tr",null,[a("td",{colspan:"6",class:"text-center"},"No hay datos que mostrar")],-1),He=[je],Le=a("tr",null,[a("td",{colspan:"6",class:"text-center"},"Cargando datos, por favor espere un momento...")],-1),Se=[Le],Ne={class:"text-sm text-disabled"},Oe={__name:"opcionb",setup(Re){const b=X.exports.extendMoment(he);b.locale("es",[K]),b.tz.setDefault("America/Guayaquil");const T=u(0),Y=u([]),p=u(1),M=u(0),g=u(10),$=u([]),E=u([]),h=u(null),I=u(!0),y=u(null),x=u(!1),w=u(!1),_=u({message:"Datos guardados",type:"success",model:!1});u("Escoge una semana");const S=u(null);async function O(){const l="https://servicio-desafios.vercel.app/semana/all/get";try{const t=await fetch(l);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const s=await t.json();if(s&&s.resp&&Array.isArray(s.data))return s.data.map(o=>({title:o.titulo,value:o._id,desafios:o.desafios}));throw new Error("La estructura de datos no es la esperada")}catch(t){return console.error("Error al obtener las semanas:",t),[]}}async function G(){w.value=!0;try{const o=b().subtract(1,"year").format("YYYY-MM-DD"),e=b().format("YYYY-MM-DD");for(var l=1,t=500,s=[];;){const v=`https://servicio-niveles-puntuacion.vercel.app/grafico-backoffice/usuarios-suscritos/?page=${l}&fechai=${o}&fechaf=${e}&limit=${t}`,r=(await(await fetch(v)).json()).data;if(r.length===0)break;s.push(...r),l+=1}if(s&&Array.isArray(s)){const v=["_id","wylexId","site","site_id","email","first_name","last_name","avatar","created_at","logged_at","logged_at_site","updated_at","validated_at","banned_at","country","phone_prefix","phone_number","gender","birth_date","identification_type","identification_number","newsletter_opt_in","provider","platform","created_in_os","created_at_suscriber_course","ciudad","telefono","birthDate","fecha_suscripcion_ecuavisados"],f=[v,...s.map(d=>{var D=[];for(var N in v)v[N]=="fecha_suscripcion_ecuavisados"?D.push(b(d.subscribed).format("YYYY-MM-DD HH:mm:ss")):D.push(d.userId[v[N]]);return D})].map(d=>d.join(",")).join(`
`),c=new Blob([f],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");if(r.download!==void 0){const d=URL.createObjectURL(c);r.setAttribute("href",d),r.setAttribute("download",`todos_usuarios_registrados_${b().format("YYYYMMDD_HHmmss")}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)}_.value={message:"Exportaci\xF3n de todos los registros completada con \xE9xito.",type:"success",model:!0}}else throw new Error("Datos no v\xE1lidos recibidos del servidor")}catch(o){console.error("Error al exportar todos los registros:",o),_.value={message:"Error al exportar todos los registros. Por favor, intente de nuevo.",type:"error",model:!0}}finally{w.value=!1}}async function Q(l){const t="https://servicio-desafios.vercel.app/desafios/search/ids";try{const s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:l})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const o=await s.json();if(o&&o.resp&&Array.isArray(o.data))return o.data.map(e=>({title:e.tituloDesafio,value:e._id}));throw new Error("La estructura de datos no es la esperada")}catch(s){return console.error("Error al obtener los desaf\xEDos:",s),[]}}async function C(l=1,t=10,s,o=null){try{if(!s)return!1;x.value=!0;var e=new Headers;e.append("Content-Type","application/json");var v={method:"GET",headers:e,redirect:"follow"};let c=`https://servicio-niveles-puntuacion.vercel.app/grafico-backoffice/usuarios-x-desafio-listado/${s}/${o||"null"}?page=${l}&limit=${t}`;var f=await fetch(c,v);const r=await f.json();r.resp&&(Y.value=r.data.map(d=>({...d.userId,subscribed:d.subscribed})),T.value=r.total,M.value=Math.ceil(r.total/r.limit)),x.value=!1}catch(c){_.value={message:"No se pudo recuperar los usuarios, recargue de nuevo.",type:"error",model:!0},x.value=!1,console.error(c.message)}}U(p,()=>{p.value>M.value&&(p.value=M.value),C(p.value,g.value,h.value,y.value)}),U(g,()=>{p.value=1,C(p.value,g.value,h.value,y.value)}),U(h,async l=>{if(l){p.value=1;const t=$.value.find(s=>s.value===l);if(t&&t.desafios){const s=await Q(t.desafios);E.value=[...s]}y.value=null,await C(p.value,g.value,l)}else E.value=[],Y.value=[],y.value=null}),U(y,async l=>{l&&h.value&&(p.value=1,await C(p.value,g.value,h.value,l))});const J=Z(()=>{const l=Y.value.length?(p.value-1)*g.value+1:0;return`Mostrando ${l} a ${Math.min(l+g.value-1,T.value)} de ${T.value} registros`});ee(async()=>{I.value=!0,$.value=await O(),setTimeout(function(){h.value=$.value[0].value},700),I.value=!1});async function W(){if(!h.value){_.value={message:"Seleccione una semana antes de exportar.",type:"error",model:!0};return}w.value=!0;const l=[];let t=1;const s=100;try{for(;;){const c=`https://servicio-niveles-puntuacion.vercel.app/grafico-backoffice/usuarios-x-desafio-listado/${h.value}/${y.value||"null"}?page=${t}&limit=${s}`,d=await(await fetch(c)).json();if(!d.resp||d.data.length===0||(l.push(...d.data.map(D=>({...D.userId,subscribed:D.subscribed}))),d.data.length<s))break;t++}const o=["_id","wylexId","site","site_id","email","first_name","last_name","avatar","created_at","logged_at","logged_at_site","updated_at","validated_at","banned_at","country","phone_prefix","phone_number","gender","birth_date","identification_type","identification_number","newsletter_opt_in","provider","platform","created_in_os","created_at_suscriber_course","ciudad","telefono","birthDate","fecha_suscripcion_ecuavisados"],e=[o,...l.map(c=>{var r=[];for(var d in o)o[d]=="fecha_suscripcion_ecuavisados"?r.push(b(c.subscribed).format("YYYY-MM-DD HH:mm:ss")):r.push(c[o[d]]);return r})].map(c=>c.join(",")).join(`
`),v=new Blob([e],{type:"text/csv;charset=utf-8;"}),f=document.createElement("a");if(f.download!==void 0){const c=URL.createObjectURL(v);f.setAttribute("href",c),f.setAttribute("download",`usuarios_desafios_${b().format("YYYYMMDD_HHmmss")}.csv`),f.style.visibility="hidden",document.body.appendChild(f),f.click(),document.body.removeChild(f)}_.value={message:"Exportaci\xF3n completada con \xE9xito.",type:"success",model:!0}}catch(o){console.error("Error al exportar datos:",o),_.value={message:"Error al exportar datos. Por favor, intente de nuevo.",type:"error",model:!0}}finally{w.value=!1}}return(l,t)=>{const s=R("v-list-item-content"),o=R("RouterLink");return V(),k("section",null,[n(ae,{modelValue:_.value.model,"onUpdate:modelValue":t[0]||(t[0]=e=>_.value.model=e),location:"top end",variant:"flat",timeout:_.value.timeout||2e3,color:_.value.type},{default:i(()=>[A(m(_.value.message),1)]),_:1},8,["modelValue","timeout","color"]),n(fe,null,{default:i(()=>[n(te,{cols:"12",sm:"12",lg:"12"},{default:i(()=>[ye,n(P,{class:"d-flex py-4 gap-4 px-0 flex-wrap",style:{"align-items":"flex-start"}},{default:i(()=>[a("div",xe,[n(j,{class:"bg-white",modelValue:g.value,"onUpdate:modelValue":t[1]||(t[1]=e=>g.value=e),density:"compact",variant:"outlined",items:[10,20,30,50]},null,8,["modelValue"]),n(j,{style:{width:"15rem"},class:"bg-white",menu:S.value,"onUpdate:menu":t[2]||(t[2]=e=>S.value=e),"no-data-text":"No existen semanas que mostrar",disabled:I.value,"item-text":"title","item-value":"value",modelValue:h.value,"onUpdate:modelValue":t[3]||(t[3]=e=>h.value=e),items:$.value,chips:"",label:"Seleccionar la semana de desaf\xEDos","menu-props":{maxHeight:"400"}},{selection:i(({item:e})=>[a("div",null,m(e.title),1)]),item:i(({item:e,props:v})=>[n(se,oe(le(v)),{default:i(()=>[n(s,null,{default:i(()=>[n(re,null,{default:i(()=>[a("p",null,"_id: "+m(e.value),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["menu","disabled","modelValue","items"]),E.value.length>0?(V(),z(j,{key:0,style:{width:"12rem"},class:"bg-white",modelValue:y.value,"onUpdate:modelValue":t[4]||(t[4]=e=>y.value=e),items:E.value,"item-text":"title","item-value":"value",chips:"",label:"Seleccionar desaf\xEDo","menu-props":{maxHeight:"400"}},{selection:i(({item:e})=>[a("div",null,m(e.title),1)]),_:1},8,["modelValue","items"])):B("",!0)]),n(be),a("div",we,[n(H,{loading:w.value,disabled:w.value||x.value,variant:"tonal",color:"info",class:"mr-3","prepend-icon":"tabler-database-export",onClick:G},{default:i(()=>[A(" Exportar usuarios registrados ")]),_:1},8,["loading","disabled"]),n(H,{loading:w.value,disabled:w.value||x.value,variant:"tonal",color:"success","prepend-icon":"tabler-screen-share",onClick:W},{default:i(()=>[A(" Exportar selecci\xF3n ")]),_:1},8,["loading","disabled"])])]),_:1}),n(ne,{class:"mt-1"},{default:i(()=>[n(ie,{class:"text-no-wrap"},{default:i(()=>[Ve,x.value?B("",!0):(V(),k("tbody",De,[(V(!0),k(de,null,ce(Y.value,e=>(V(),k("tr",{key:e._id,style:{height:"3.75rem"}},[a("td",null,[a("div",Ye,[n(ue,{variant:"tonal",color:"success",class:"me-3",size:"38"},{default:i(()=>[e.avatar?(V(),z(pe,{key:0,src:e.avatar},null,8,["src"])):(V(),k("span",ke,m(L(_e)(`${e.first_name} ${e.last_name}`)),1))]),_:2},1024),a("div",Me,[a("h6",$e,[n(o,{to:{name:"apps-user-view-id",params:{id:e.wylexId}},class:"font-weight-medium user-list-name"},{default:i(()=>[A(m(e.first_name)+" "+m(e.last_name),1)]),_:2},1032,["to"])]),a("span",Ee,"@"+m(e.email),1)])])]),a("td",null,[a("span",Ce,m(e.birthDate||e.birth_date||"N/A"),1)]),a("td",null,[a("span",Ue,m(e.telefono||e.phone_number||"N/A"),1)]),a("td",null,[a("span",Ae,m(L(b)(e.subscribed).format("YYYY-MM-DD HH:mm:ss")),1)]),a("td",null,[a("span",Te,m(e.ciudad||"N/A"),1)]),a("td",Ie,[n(H,{icon:"",size:"x-small",color:"default",variant:"text",to:{name:"apps-user-view-id",params:{id:e.wylexId}}},{default:i(()=>[n(me,{size:"22",icon:"tabler-eye"})]),_:2},1032,["to"])])]))),128))])),F(a("tfoot",null,He,512),[[q,!Y.value.length&&!x.value]]),F(a("tfoot",null,Se,512),[[q,x.value]])]),_:1}),n(ve),n(P,{class:"d-flex align-center flex-wrap justify-space-between gap-4 py-3 px-5"},{default:i(()=>[a("span",Ne,m(L(J)),1),n(ge,{modelValue:p.value,"onUpdate:modelValue":t[5]||(t[5]=e=>p.value=e),size:"small","total-visible":5,length:M.value},null,8,["modelValue","length"])]),_:1})]),_:1})]),_:1})]),_:1})])}}};export{Oe as default};
