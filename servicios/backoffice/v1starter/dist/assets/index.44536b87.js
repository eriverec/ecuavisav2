import{R as X,U as Z,r,Q as L,v as $,as as ee,o as d,x as y,a as s,w as c,q as A,t as m,f as oe,e as ae,h as j,b as t,aT as O,n as te,b1 as se,p as C,g as le,aW as re,u as _,F as B,C as ne,N as D,c as U,a3 as R,a2 as ce,V as ie}from"./index.88d3c7f5.js";import{M as ue}from"./index.50982b4e.js";import{V as de}from"./VSpacer.2a3e77c9.js";import{V as me}from"./VPagination.9412c3b8.js";const pe=t("h1",null,"Listado de Reembolsos",-1),ve={class:"me-3 d-flex gap-4"},fe={class:"app-reembolso-search-filter d-flex align-top"},he=t("thead",null,[t("tr",null,[t("th",{scope:"col"},"Nombre"),t("th",{scope:"col"},"Apellido"),t("th",{scope:"col"},"Email"),t("th",{scope:"col"},"ID Transacci\xF3n"),t("th",{scope:"col"},"Fecha de solicitud"),t("th",{scope:"col"},"Nombre de Paquete"),t("th",{scope:"col"},"Acciones")])],-1),ge={key:0},ye={class:"text-center",style:{width:"5rem"}},_e={key:1},be={colspan:"7",class:"text-center"},xe={key:2},we=t("tr",null,[t("td",{colspan:"7",class:"text-center"},"Cargando datos, por favor espere un momento...")],-1),Ve=[we],ke={class:"text-sm text-disabled"},ze={__name:"index",setup(Ee){const b=X.exports.extendMoment(ue);b.locale("es",[Z]),b.tz.setDefault("America/Guayaquil");const M=r(0),x=r([]),p=r([]),v=r(1),w=r(0),f=r(10),h=r(!1),V=r(!1),k=r(!1),z=r(""),l=r({message:"Datos guardados",type:"success",model:!1}),g=r("2"),Y=[{value:"2",text:"Pendiente"},{value:"1",text:"Proceso terminado"},{value:"3",text:"Rechazado"},{value:"0",text:"Sin proceso"}];async function F(o){if(console.log("Iniciando proceso de devoluci\xF3n:",o),window.confirm(`\xBFProcesar devoluci\xF3n (${o})?`))try{console.log("Enviando solicitud de procesamiento al servidor...");const e=await fetch("https://ecuavisa-suscripciones.vercel.app/reembolso/backoffice-user/accept",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_id:o,estado_reembolso:"1"})});if(console.log("Respuesta recibida:",e),!e.ok)throw new Error(`Error al procesar la devoluci\xF3n: ${e.status} ${e.statusText}`);const n=await e.json();console.log("Datos de respuesta:",n),l.value={message:"Devoluci\xF3n procesada exitosamente",type:"success",model:!0},E()}catch(e){console.error("Error detallado al procesar la devoluci\xF3n:",e),l.value={message:`Error al procesar la devoluci\xF3n: ${e.message}`,type:"error",model:!0}}}async function H(o){if(console.log("Iniciando rechazo de devoluci\xF3n:",o),window.confirm(`\xBFRechazar devoluci\xF3n (${o})?`))try{console.log("Enviando solicitud de rechazo al servidor...");const e=await fetch("https://ecuavisa-suscripciones.vercel.app/reembolso/backoffice-user/accept-custom",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_id:o,estado_reembolso:"3"})});if(console.log("Respuesta recibida:",e),!e.ok)throw new Error(`Error al rechazar la devoluci\xF3n: ${e.status} ${e.statusText}`);const n=await e.json();console.log("Datos de respuesta:",n),l.value={message:"Devoluci\xF3n rechazada exitosamente",type:"success",model:!0},E()}catch(e){console.error("Error detallado al rechazar la devoluci\xF3n:",e),l.value={message:`Error al rechazar la devoluci\xF3n: ${e.message}`,type:"error",model:!0}}}function I(o){return b(o).format("DD/MM/YYYY HH:mm:ss")}async function K(o){const a=`https://ecuavisa-suscripciones.vercel.app/reembolso/backoffice/solicitudes-list?estado=${o}&page=1&limit=1000`,n=await(await fetch(a)).json();return n.resp?n:null}async function E(){if(!h.value){h.value=!0;try{const o=await K(g.value);o&&o.data?(x.value=o.data,p.value=o.data,M.value=o.data.length,N()):(x.value=[],p.value=[],M.value=0,N())}catch(o){console.error("Error al obtener los datos:",o),l.value={message:"No se pudo recuperar los datos, recargue de nuevo.",type:"error",model:!0}}finally{h.value=!1}}}function N(){w.value=Math.ceil(p.value.length/f.value),v.value=Math.min(v.value,w.value),v.value===0&&w.value>0&&(v.value=1)}function T(){V.value=!0;const o=z.value.toLowerCase();p.value=x.value.filter(a=>a.user.first_name.toLowerCase().includes(o)||a.user.last_name.toLowerCase().includes(o)),N(),V.value=!1}L(f,N),L(g,(o,a)=>{o!==a&&E()});const J=$(()=>{const o=p.value.length?(v.value-1)*f.value+1:0,a=Math.min(o+f.value-1,p.value.length);return`Mostrando ${o} a ${a} de ${p.value.length} registros`}),P=$(()=>{const o=(v.value-1)*f.value,a=o+f.value;return p.value.slice(o,a)}),Q=$(()=>{switch(g.value){case"2":return"No hay reembolsos pendientes que mostrar. Escoge otro estado.";case"1":return"No hay reembolsos procesados que mostrar. Escoge otro estado.";case"3":return"No hay reembolsos rechazados que mostrar. Escoge otro estado.";case"0":return"No hay reembolsos sin proceso que mostrar. Escoge otro estado.";default:return"No hay datos que mostrar"}});ee(()=>{E()});async function G(){try{k.value=!0;const o=x.value;let e=["ID","Nombre","Apellido","Email","ID Transacci\xF3n","Nombre de Paquete"].join(",")+`
`;o.forEach(u=>{var S,q;const W=[u._id||"N/A",u.user.first_name||"N/A",u.user.last_name||"N/A",u.user.email||"N/A",u.transaction_id,((q=(S=u.transaction[0])==null?void 0:S.transaction)==null?void 0:q.product_description)||"N/A"];e+=W.join(",")+`
`});const n=new Blob([e],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");if(i.download!==void 0){const u=URL.createObjectURL(n);i.setAttribute("href",u),i.setAttribute("download",`reembolsos_${b().format("YYYYMMDD_HHmmss")}.csv`),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)}l.value={message:"Exportaci\xF3n completada con \xE9xito.",type:"success",model:!0}}catch(o){console.error("Error al exportar datos:",o),l.value={message:"Error al exportar datos. Por favor, intente de nuevo.",type:"error",model:!0}}finally{k.value=!1}}return(o,a)=>(d(),y("section",null,[s(oe,{modelValue:l.value.model,"onUpdate:modelValue":a[0]||(a[0]=e=>l.value.model=e),location:"top end",variant:"flat",timeout:l.value.timeout||2e3,color:l.value.type},{default:c(()=>[A(m(l.value.message),1)]),_:1},8,["modelValue","timeout","color"]),s(ie,null,{default:c(()=>[s(ae,{cols:"12",sm:"12",lg:"12"},{default:c(()=>[pe,s(j,{class:"d-flex py-4 gap-4 px-0 flex-wrap",style:{"align-items":"flex-start"}},{default:c(()=>[t("div",ve,[s(O,{class:"bg-white",modelValue:f.value,"onUpdate:modelValue":a[1]||(a[1]=e=>f.value=e),density:"compact",variant:"outlined",items:[10,20,30,50]},null,8,["modelValue"]),s(O,{modelValue:g.value,"onUpdate:modelValue":a[2]||(a[2]=e=>g.value=e),items:Y,"item-title":"text","item-value":"value",label:"Estado",density:"compact",variant:"outlined",style:{width:"200px"}},null,8,["modelValue"]),s(te,{modelValue:z.value,"onUpdate:modelValue":a[3]||(a[3]=e=>z.value=e),label:"Buscar por nombre o apellido","prepend-inner-icon":"mdi-magnify","single-line":"","hide-details":"",onKeyup:se(T,["enter"]),style:{width:"300px"}},null,8,["modelValue","onKeyup"]),s(C,{color:"primary",loading:V.value,disabled:V.value||h.value,onClick:T},{default:c(()=>[A(" Buscar ")]),_:1},8,["loading","disabled"])]),s(de),t("div",fe,[s(C,{loading:k.value,disabled:k.value||h.value,variant:"tonal",color:"success","prepend-icon":"tabler-screen-share",onClick:G},{default:c(()=>[A(" Exportar datos ")]),_:1},8,["loading","disabled"])])]),_:1}),s(le,{class:"mt-1"},{default:c(()=>[s(re,{class:"text-no-wrap"},{default:c(()=>[he,!h.value&&_(P).length>0?(d(),y("tbody",ge,[(d(!0),y(B,null,ne(_(P),e=>{var n,i;return d(),y("tr",{key:e._id,style:{height:"3.75rem"}},[t("td",null,m(e.hasOwnProperty("user")?e.user.first_name:"usuario eliminado"),1),t("td",null,m(e.hasOwnProperty("user")?e.user.last_name:"usuario eliminado"),1),t("td",null,m(e.hasOwnProperty("user")?e.user.email:"usuario eliminado"),1),t("td",null,m(e.transaction_id),1),t("td",null,m(I(e.created_at)),1),t("td",null,m(((i=(n=e.transaction[0])==null?void 0:n.transaction)==null?void 0:i.product_description)||"N/A"),1),t("td",ye,[g.value==="2"?(d(),y(B,{key:0},[s(C,{icon:"",size:"x-small",color:"default",variant:"text",onClick:u=>F(e.transaction_id)},{default:c(()=>[s(D,{size:"22",icon:"mdi-credit-card-refund"})]),_:2},1032,["onClick"]),s(C,{icon:"",size:"x-small",color:"error",variant:"text",onClick:u=>H(e.transaction_id)},{default:c(()=>[s(D,{size:"22",icon:"mdi-close"})]),_:2},1032,["onClick"])],64)):g.value==="1"?(d(),U(D,{key:1,size:"22",icon:"mdi-check-circle",color:"success"})):g.value==="3"?(d(),U(D,{key:2,size:"22",icon:"mdi-close-circle",color:"error"})):R("",!0)])])}),128))])):R("",!0),!h.value&&_(P).length===0?(d(),y("tfoot",_e,[t("tr",null,[t("td",be,m(_(Q)),1)])])):R("",!0),h.value?(d(),y("tfoot",xe,Ve)):R("",!0)]),_:1}),s(ce),s(j,{class:"d-flex align-center flex-wrap justify-space-between gap-4 py-3 px-5"},{default:c(()=>[t("span",ke,m(_(J)),1),s(me,{modelValue:v.value,"onUpdate:modelValue":a[4]||(a[4]=e=>v.value=e),size:"small","total-visible":5,length:w.value},null,8,["modelValue","length"])]),_:1})]),_:1})]),_:1})]),_:1})]))}};export{ze as default};
