import{P as V}from"./papaparse.min.b6588840.js";import{M as k,o as m,x as f,a as r,w as o,q as d,t as u,f as I,aR as w,b2 as S,e as y,b as l,n as b,p as h,N as p,V as v,F as C,C as x,c as _,$ as U,a0 as L,a1 as P,Z as E,g as T,h as D,aW as A,a3 as N,bR as R,b0 as j,bd as q,be as B}from"./index.88d3c7f5.js";import{V as Q}from"./VSpacer.2a3e77c9.js";const z={name:"UserList",emits:["delete-user","add-user","export","update-users","close"],props:{users:{type:Array,required:!0},campaignTitle:{type:String,required:!0},usersPerPage:{type:Number,default:10},campaignId:{type:String,required:!0}},data(){return{filterLocal:"",currentPageLocal:1,timeoutId:null,filteredUsers:[],showSearchDialog:!1,searchQuery:"",searchResults:[],isSearching:!1,searchTimeout:null,loadingAdd:!1,snackbar:{show:!1,text:"",color:"success"}}},watch:{users:{immediate:!0,handler(a){this.filteredUsers=a}}},computed:{totalPages(){return Math.ceil(this.filteredUsers.length/this.usersPerPage)},currentUsers(){const a=(this.currentPageLocal-1)*this.usersPerPage,e=a+this.usersPerPage;return this.filteredUsers.slice(a,e)}},methods:{async refreshCampaignData(){try{const e=await(await fetch(`https://ads-service.vercel.app/campaign/${this.campaignId}/user`)).json();e&&e[0]&&(this.filteredUsers=e[0].userId)}catch(a){console.error("Error al actualizar datos:",a)}},async handleAddSpecificUser(a){this.loadingAdd=!0;try{const i=await(await fetch(`https://ads-service.vercel.app/campaign/add-user/${this.campaignId}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a.wylexId})})).json();if(i.resp)this.snackbar={show:!0,text:"Usuario agregado exitosamente",color:"success"},await this.refreshCampaignData();else throw new Error(i.error||"Error al agregar usuario")}catch(e){this.snackbar={show:!0,text:`Error: ${e.message}`,color:"error"}}finally{this.loadingAdd=!1}},async handleDeleteUser(a){try{(await(await fetch(`https://ads-service.vercel.app/campaign/delete-user/${this.campaignId}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a})})).json()).resp&&(this.snackbar={show:!0,text:"Usuario eliminado exitosamente",color:"success"},await this.refreshCampaignData())}catch{this.snackbar={show:!0,text:"Error al eliminar usuario",color:"error"}}},async handleFileChange(a){const e=a.target.files[0];if(!!e){if(!e.name.endsWith(".csv")){this.snackbar={show:!0,text:"Por favor, selecciona un archivo CSV",color:"error"},a.target.value="";return}try{V.parse(e,{header:!0,complete:async i=>{try{if(!i.data||!i.data.length)throw new Error("El archivo est\xE1 vac\xEDo");const n=i.data.filter(s=>s.id&&s.id.trim()!=="").map(s=>parseInt(s.id)).filter(s=>!isNaN(s));if(n.length===0)throw new Error("No se encontraron IDs v\xE1lidos");if(n.length>3e4)throw new Error("El m\xE1ximo es 30,000 usuarios");for(const s of n)await this.handleAddSpecificUser({wylexId:s});this.snackbar={show:!0,text:`${n.length} usuarios procesados exitosamente`,color:"success"},await this.refreshCampaignData()}catch(n){this.snackbar={show:!0,text:`Error: ${n.message}`,color:"error"}}}})}catch(i){this.snackbar={show:!0,text:`Error: ${i.message}`,color:"error"}}finally{a.target.value=""}}},async handleSearch(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(async()=>{if(!this.searchQuery||this.searchQuery.length<4){this.searchResults=[];return}this.isSearching=!0;try{const e=await(await fetch(`https://ads-service.vercel.app/busqueda/user/?s=${encodeURIComponent(this.searchQuery)}`)).json();e.resp?this.searchResults=e.data:(this.searchResults=[],this.snackbar={show:!0,text:e.error||"Error en la b\xFAsqueda",color:"error"})}catch(a){console.error("Error en b\xFAsqueda:",a),this.searchResults=[],this.snackbar={show:!0,text:"Error en la b\xFAsqueda",color:"error"}}finally{this.isSearching=!1}},500)},handleAddUser(){this.searchQuery="",this.searchResults=[],this.showSearchDialog=!0},closeSearchDialog(){this.showSearchDialog=!1,this.refreshCampaignData()},filtrarUsuarios(){clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{const a=this.filterLocal.toLowerCase();this.filteredUsers=this.users.filter(e=>`${e.firstname||e.first_name} ${e.lastname||e.last_name}`.toLowerCase().includes(a)?!0:Object.keys(e).some(n=>n!=="wylexId"&&e[n].toString().toLowerCase().includes(a))),this.currentPageLocal=1},300)}}},F=a=>(q("data-v-11eeceda"),a=a(),B(),a),O={class:""},J={class:"d-flex gap-3 flex-wrap"},M={class:"text-xs text-disabled"},W={class:"espacio-right-2"},Z=F(()=>l("thead",null,[l("tr",null,[l("th",null,"Nombre"),l("th",null,"Correo"),l("th",null,"Acciones")])],-1));function G(a,e,i,n,s,c){return m(),f("div",null,[r(I,{modelValue:s.snackbar.show,"onUpdate:modelValue":e[0]||(e[0]=t=>s.snackbar.show=t),color:s.snackbar.color,timeout:2e3,location:"top"},{default:o(()=>[d(u(s.snackbar.text),1)]),_:1},8,["modelValue","color"]),r(w,{class:"px-0"},{default:o(()=>[d('Esta es la lista de usuarios de la campa\xF1a "'+u(i.campaignTitle)+'":',1)]),_:1}),r(S),r(v,{justify:"space-between",class:"my-4"},{default:o(()=>[r(y,{cols:"3"},{default:o(()=>[l("div",O,[r(b,{"append-inner-icon":"tabler-user-search",onInput:c.filtrarUsuarios,modelValue:s.filterLocal,"onUpdate:modelValue":e[1]||(e[1]=t=>s.filterLocal=t),label:"Buscar usuarios dentro del listado"},null,8,["onInput","modelValue"])])]),_:1}),r(y,{cols:"auto"},{default:o(()=>[l("div",J,[r(h,{color:"info",onClick:e[2]||(e[2]=t=>a.$emit("export"))},{default:o(()=>[d(" Descargar Usuarios"),r(p,{end:"",icon:"tabler-download"})]),_:1}),r(h,{color:"success",onClick:c.handleAddUser},{default:o(()=>[d(" A\xF1adir usuarios"),r(p,{end:"",icon:"mdi-account-plus"})]),_:1},8,["onClick"]),r(h,{color:"primary",onClick:e[3]||(e[3]=t=>a.$refs.fileInput.click())},{default:o(()=>[d(" Importar CSV"),r(p,{end:"",icon:"mdi-file-upload"})]),_:1}),l("input",{ref:"fileInput",type:"file",accept:".csv",style:{display:"none"},onChange:e[4]||(e[4]=(...t)=>c.handleFileChange&&c.handleFileChange(...t))},null,544)])]),_:1})]),_:1}),r(E,{lines:"two"},{default:o(()=>[(m(!0),f(C,null,x(c.currentUsers,(t,g)=>(m(),_(U,{key:g,border:""},{append:o(()=>[l("div",W,[r(h,{icon:"",size:"x-small",color:"error",variant:"text",onClick:H=>c.handleDeleteUser(t.wylexId)},{default:o(()=>[r(p,{size:"22",icon:"tabler-trash"})]),_:2},1032,["onClick"])])]),default:o(()=>[r(L,null,{default:o(()=>[l("span",null,u(t.firstname||t.first_name)+" "+u(t.lastname||t.last_name),1)]),_:2},1024),r(P,{class:"mt-1",color:"info"},{default:o(()=>[l("span",M,"Correo: "+u(t.email),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),r(h,{variant:"tonal",onClick:e[5]||(e[5]=t=>s.currentPageLocal--),disabled:s.currentPageLocal<=1,size:"small",color:"primary"},{default:o(()=>[r(p,{start:"",icon:"tabler-arrow-left"}),d(" Anterior ")]),_:1},8,["disabled"]),r(h,{variant:"tonal",onClick:e[6]||(e[6]=t=>s.currentPageLocal++),disabled:s.currentPageLocal>=c.totalPages,size:"small",color:"primary",class:"ma-3"},{default:o(()=>[d(" Siguiente "),r(p,{end:"",icon:"tabler-arrow-right"})]),_:1},8,["disabled"]),r(j,{modelValue:s.showSearchDialog,"onUpdate:modelValue":e[8]||(e[8]=t=>s.showSearchDialog=t),"max-width":"800px"},{default:o(()=>[r(T,null,{default:o(()=>[r(w,null,{default:o(()=>[d("Buscar Usuarios")]),_:1}),r(D,null,{default:o(()=>[r(b,{modelValue:s.searchQuery,"onUpdate:modelValue":e[7]||(e[7]=t=>s.searchQuery=t),onInput:c.handleSearch,label:"Buscar por nombre, correo o tel\xE9fono (m\xEDnimo 4 caracteres)","append-inner-icon":"tabler-search",loading:s.isSearching},null,8,["modelValue","onInput","loading"]),s.searchResults.length>0?(m(),_(A,{key:0},{default:o(()=>[Z,l("tbody",null,[(m(!0),f(C,null,x(s.searchResults,t=>(m(),f("tr",{key:t.wylexId},[l("td",null,u(t.first_name)+" "+u(t.last_name),1),l("td",null,u(t.email),1),l("td",null,[r(h,{size:"small",color:"primary",onClick:g=>c.handleAddSpecificUser(t),loading:s.loadingAdd},{default:o(()=>[d(" Agregar ")]),_:2},1032,["onClick","loading"])])]))),128))])]),_:1})):N("",!0)]),_:1}),r(R,null,{default:o(()=>[r(Q),r(h,{color:"primary",text:"",onClick:c.closeSearchDialog},{default:o(()=>[d(" Cerrar ")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const $=k(z,[["render",G],["__scopeId","data-v-11eeceda"]]);export{$ as default};
