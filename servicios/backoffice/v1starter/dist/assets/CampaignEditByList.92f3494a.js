import{P as D}from"./papaparse.min.b6588840.js";import{M as W,r as i,v as U,as as G,o as d,x as y,a as o,w as n,q as p,t as u,f as Q,b as t,p as v,n as B,F as j,C as L,u as T,aW as A,g as H,aR as K,h as X,c as P,a3 as Y,b0 as Z,bd as ee,be as ae}from"./index.88d3c7f5.js";import{V as te}from"./VPagination.9412c3b8.js";import{V as le}from"./VAlert.3e8ed100.js";const N=h=>(ee("data-v-644a7d65"),h=h(),ae(),h),se={class:"d-flex align-center justify-space-between mb-4"},oe={class:"text-h5"},re=N(()=>t("p",{class:"text-subtitle-1"},"Gesti\xF3n de usuarios",-1)),ne={class:"d-flex gap-2"},ie=N(()=>t("thead",null,[t("tr",null,[t("th",null,"Nombre"),t("th",null,"Email"),t("th",{class:"text-center"},"Acciones")])],-1)),ce={class:"text-center"},ue={class:"d-flex justify-center mt-4"},de=N(()=>t("thead",null,[t("tr",null,[t("th",null,"Nombre"),t("th",null,"Email"),t("th",{class:"text-center"},"Acci\xF3n")])],-1)),pe={class:"text-center"},me={__name:"CampaignEditByList",props:{campaignData:{type:Object,required:!0}},emits:["update"],setup(h,{emit:fe}){const g=h,x=i([]),b=i(""),V=i(1),C=i(10),w=i(!1),m=i(""),E=i([]),_=i(!1),I=i(!1),O=i(null),r=i({show:!1,text:"",color:"success"}),S=U(()=>{const l=b.value.toLowerCase();return x.value.filter(e=>`${e.firstname||e.first_name} ${e.lastname||e.last_name}`.toLowerCase().includes(l)||e.email.toLowerCase().includes(l))}),R=U(()=>Math.ceil(S.value.length/C.value)),q=U(()=>{const l=(V.value-1)*C.value,e=l+C.value;return S.value.slice(l,e)}),k=async()=>{try{const e=await(await fetch(`https://ads-service.vercel.app/campaign/${g.campaignData._id}/user`)).json();e&&e[0]&&(x.value=e[0].userId)}catch(l){console.error("Error al cargar usuarios:",l),r.value={show:!0,text:"Error al cargar usuarios",color:"error"}}},F=async()=>{if(!(!m.value||m.value.length<4)){_.value=!0;try{const e=await(await fetch(`https://ads-service.vercel.app/busqueda/user/?s=${encodeURIComponent(m.value)}`)).json();if(e.resp)E.value=e.data;else throw new Error(e.error||"Error en la b\xFAsqueda")}catch(l){r.value={show:!0,text:l.message,color:"error"}}finally{_.value=!1}}},$=async l=>{I.value=!0;try{(await(await fetch(`https://ads-service.vercel.app/campaign/add-user/${g.campaignData._id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:l.wylexId})})).json()).resp&&(r.value={show:!0,text:"Usuario agregado exitosamente",color:"success"},await k())}catch{r.value={show:!0,text:"Error al agregar usuario",color:"error"}}finally{I.value=!1}},M=async l=>{try{(await(await fetch(`https://ads-service.vercel.app/campaign/delete-user/${g.campaignData._id}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:l})})).json()).resp&&(r.value={show:!0,text:"Usuario eliminado exitosamente",color:"success"},await k())}catch{r.value={show:!0,text:"Error al eliminar usuario",color:"error"}}},z=l=>{const e=l.target.files[0];if(!!e){if(!e.name.endsWith(".csv")){r.value={show:!0,text:"Por favor, selecciona un archivo CSV",color:"error"};return}D.parse(e,{header:!0,complete:async a=>{try{if(!a.data||!a.data.length)throw new Error("El archivo est\xE1 vac\xEDo");const s=a.data.filter(c=>c.id&&c.id.trim()!=="").map(c=>parseInt(c.id)).filter(c=>!isNaN(c));if(s.length===0)throw new Error("No se encontraron IDs v\xE1lidos");if(s.length>3e4)throw new Error("El m\xE1ximo es 30,000 usuarios");for(const c of s)await $({wylexId:c});r.value={show:!0,text:`${s.length} usuarios importados exitosamente`,color:"success"}}catch(s){r.value={show:!0,text:s.message,color:"error"}}}})}},J=()=>{const l=[["ID","Nombre","Apellido","Email"],...x.value.map(f=>[f.wylexId,f.firstname||f.first_name,f.lastname||f.last_name,f.email])],e=D.unparse(l),a=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),c=URL.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",`usuarios_campa\xF1a_${g.campaignData._id}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)};return G(k),(l,e)=>(d(),y("div",null,[o(Q,{modelValue:r.value.show,"onUpdate:modelValue":e[0]||(e[0]=a=>r.value.show=a),color:r.value.color,timeout:3e3},{default:n(()=>[p(u(r.value.text),1)]),_:1},8,["modelValue","color"]),t("div",se,[t("div",null,[t("h2",oe,u(g.campaignData.campaignTitle),1),re]),t("div",ne,[o(v,{color:"primary","prepend-icon":"mdi-plus",onClick:e[1]||(e[1]=a=>w.value=!0)},{default:n(()=>[p(" A\xF1adir usuarios ")]),_:1}),o(v,{color:"secondary","prepend-icon":"mdi-upload",onClick:e[2]||(e[2]=a=>l.$refs.fileInput.click())},{default:n(()=>[p(" Importar CSV ")]),_:1}),o(v,{color:"info","prepend-icon":"mdi-download",onClick:J},{default:n(()=>[p(" Exportar ")]),_:1})])]),t("input",{ref_key:"fileInput",ref:O,type:"file",accept:".csv",class:"d-none",onChange:z},null,544),o(B,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=a=>b.value=a),"prepend-inner-icon":"mdi-magnify",label:"Buscar usuarios",clearable:"",class:"mb-4"},null,8,["modelValue"]),o(A,null,{default:n(()=>[ie,t("tbody",null,[(d(!0),y(j,null,L(T(q),a=>(d(),y("tr",{key:a.wylexId},[t("td",null,u(a.firstname||a.first_name)+" "+u(a.lastname||a.last_name),1),t("td",null,u(a.email),1),t("td",ce,[o(v,{icon:"mdi-delete",variant:"text",color:"error",size:"small",onClick:s=>M(a.wylexId)},null,8,["onClick"])])]))),128))])]),_:1}),t("div",ue,[o(te,{modelValue:V.value,"onUpdate:modelValue":e[4]||(e[4]=a=>V.value=a),length:T(R),"total-visible":7},null,8,["modelValue","length"])]),o(Z,{modelValue:w.value,"onUpdate:modelValue":e[7]||(e[7]=a=>w.value=a),"max-width":"800",persistent:""},{default:n(()=>[o(H,null,{default:n(()=>[o(K,{class:"d-flex justify-space-between align-center"},{default:n(()=>[p(" Buscar usuarios "),o(v,{icon:"mdi-close",variant:"text",onClick:e[5]||(e[5]=a=>w.value=!1)})]),_:1}),o(X,null,{default:n(()=>[o(B,{modelValue:m.value,"onUpdate:modelValue":[e[6]||(e[6]=a=>m.value=a),F],label:"Buscar por nombre o email","prepend-inner-icon":"mdi-magnify",clearable:"",loading:_.value},null,8,["modelValue","loading"]),E.value.length?(d(),P(A,{key:0},{default:n(()=>[de,t("tbody",null,[(d(!0),y(j,null,L(E.value,a=>(d(),y("tr",{key:a.wylexId},[t("td",null,u(a.first_name)+" "+u(a.last_name),1),t("td",null,u(a.email),1),t("td",pe,[o(v,{color:"primary",size:"small",loading:I.value,onClick:s=>$(a)},{default:n(()=>[p(" Agregar ")]),_:2},1032,["loading","onClick"])])]))),128))])]),_:1})):m.value&&!_.value?(d(),P(le,{key:1,type:"info",class:"mt-4"},{default:n(()=>[p(" No se encontraron resultados ")]),_:1})):Y("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},we=W(me,[["__scopeId","data-v-644a7d65"]]);export{we as default};
