import{M as O,r as h,Q as S,as as q,o as b,x as _,b as k,a as d,w as y,N as $,q as C,p as D,a$ as U,c as W,u as H,bx as Q,bb as N,bd as Y,be as J}from"./index.88d3c7f5.js";import{V as K}from"./VTooltip.2d0a8708.js";const T=v=>(Y("data-v-4fb65fac"),v=v(),J(),v),X={class:"stats-container"},Z={class:"d-flex align-center justify-space-between mb-6"},G=T(()=>k("div",{class:"date-picker-wrapper",style:{width:"calc(100% - 48px)"}},null,-1)),ee={class:"d-flex justify-center align-center gap-6 mb-6"},ae={key:0,class:"text-center py-8"},te=T(()=>k("div",{class:"mt-4"},"Cargando estad\xEDsticas...",-1)),se={key:1},oe={key:1,class:"text-center py-8"},ne={__name:"section_stats",props:{campaignId:{type:String,required:!0},dateRange:{type:Object,required:!0}},emits:["loading"],setup(v,{emit:B}){const r=v,x=h(!1),R=h(!1),p=h(!0),l=h(!0),E={preview:"#7BD5F5",click:"#4FB5E6"},j=e=>{const o=new Date(e);return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`},V=new Date;h({start:j(V),end:j(V)});const u=h({series:[],options:{chart:{type:"bar",height:350,toolbar:{show:!1},stacked:!0,background:"transparent"},plotOptions:{bar:{horizontal:!0,barHeight:"35%",borderRadius:[4,4,4,4],distributed:!1,rangeBarOverlap:!0,rangeBarGroupRows:!1}},colors:[E.preview,E.click],dataLabels:{enabled:!0,style:{colors:["#666666"]},formatter:function(e){return e!==null?e:""}},stroke:{width:0,colors:["transparent"]},xaxis:{categories:[],labels:{style:{colors:"#666666"}}},yaxis:{labels:{style:{fontSize:"14px",fontFamily:"Inter, sans-serif",fontWeight:600,colors:"#666666"},maxWidth:300,trim:!1,formatter:function(e){return e?String(e).length>40?String(e).substr(0,37)+"...":String(e):""}}},fill:{opacity:1},tooltip:{y:{formatter:function(e){return e+" interacciones"}}},legend:{show:!1},theme:{mode:"dark"}}}),z=(e,o)=>{const a=new Map;e.filter(s=>s.firstPath&&s.firstPath!=="null").forEach(s=>{const n=s.firstPath;a.has(n)||a.set(n,{preview:null,click:null}),s.groupedByType.forEach(c=>{const i=a.get(n);c.type==="preview"&&c.total>0?i.preview=(i.preview||0)+c.total:c.type==="click"&&c.total>0&&(i.click=(i.click||0)+c.total)})}),o.filter(s=>s.subseccion&&s.subseccion!=="null").forEach(s=>{const n=s.subseccion;a.has(n)||a.set(n,{preview:null,click:null}),s.groupedByType.forEach(c=>{const i=a.get(n);c.type==="preview"&&c.total>0?i.preview=(i.preview||0)+c.total:c.type==="click"&&c.total>0&&(i.click=(i.click||0)+c.total)})});const g=Array.from(a.keys()),f=[];return l.value&&f.push({name:"Impresiones",data:g.map(s=>{const n=a.get(s).preview;return n!==null?n:null})}),p.value&&f.push({name:"Clicks",data:g.map(s=>{const n=a.get(s).click;return n!==null?n:null})}),{categories:g,series:f}},w=async()=>{x.value=!0,B("loading",!0);try{const[e,o]=await Promise.all([N.get(`https://ads-service.vercel.app/grafico/stats-secciones/${r.campaignId}`,{params:{fechai:r.dateRange.start,fechaf:r.dateRange.end,page:1,limit:5e5}}),N.get(`https://ads-service.vercel.app/grafico/stats-subsecciones/${r.campaignId}`,{params:{fechai:r.dateRange.start,fechaf:r.dateRange.end,page:1,limit:5e5}})]);if(console.log("Sections Response:",e.data),console.log("Subsections Response:",o.data),e.data.resp&&o.data.resp){const{categories:a,series:g}=z(e.data.data,o.data.data);u.value={...u.value,series:g,options:{...u.value.options,xaxis:{...u.value.options.xaxis,categories:a}}}}}catch(e){console.error("Error fetching stats:",e)}finally{x.value=!1,B("loading",!1)}};S([p,l],()=>{if(!p.value&&!l.value){l.value=!0;return}w()}),S(()=>r.campaignId,e=>{e&&w()},{immediate:!0}),S(()=>r.dateRange,e=>{e&&w()},{deep:!0}),q(()=>{r.campaignId&&w()});const F=async()=>{var e,o;if(!((e=r.dateRange)!=null&&e.start)||!((o=r.dateRange)!=null&&o.end)){console.error("Rango de fechas no v\xE1lido");return}R.value=!0;try{const a=new URL(`https://ads-service.vercel.app/grafico/stats-subsecciones/btn-descargar/${r.campaignId}`);a.searchParams.append("fechai",r.dateRange.start),a.searchParams.append("fechaf",r.dateRange.end),a.searchParams.append("page","1"),a.searchParams.append("limit","500000");const f=await(await fetch(a)).json();if(f.resp&&f.data){const s=new Map;f.data.forEach(t=>{const I=`${t.user.wylexId}-${t.subseccion||"noticias"}`;s.has(I)||s.set(I,{wylexId:t.user.wylexId,first_name:t.user.first_name||"",last_name:t.user.last_name||"",email:t.user.email||"",phone_number:t.user.phone_number||"",metadato:t.subseccion||"noticias",views:0,clicks:0});const P=s.get(I);t.type==="preview"?P.views+=t.total:t.type==="click"&&(P.clicks+=t.total)});const n=[];n.push(["ID Wylex","Nombre","Apellido","Email","Tel\xE9fono","Secci\xF3n/Subsecci\xF3n","Total Impresiones","Total Clicks"].join(",")),s.forEach(t=>{n.push([`"${t.wylexId}"`,`"${t.first_name}"`,`"${t.last_name}"`,`"${t.email}"`,`"${t.phone_number}"`,`"${t.metadato}"`,t.views,t.clicks].join(","))});const c=n.join(`
`),i=new Blob([c],{type:"text/csv;charset=utf-8;"}),m=document.createElement("a"),M=r.dateRange.start.split("-").join(""),A=r.dateRange.end.split("-").join(""),L=`stats_secciones_${M}_${A}.csv`;m.href=URL.createObjectURL(i),m.setAttribute("download",L),document.body.appendChild(m),m.click(),document.body.removeChild(m)}}catch(a){console.error("Error al descargar los datos:",a)}finally{R.value=!1}};return(e,o)=>(b(),_("div",X,[k("div",Z,[G,d(D,{icon:"",variant:"text",size:"large",loading:R.value,onClick:F,class:"download-btn"},{default:y(()=>[d($,{icon:"mdi-account-arrow-down-outline",size:"24",color:"grey-darken-1"}),d(K,{activator:"parent",location:"top"},{default:y(()=>[C("Descargar usuarios")]),_:1})]),_:1},8,["loading"])]),k("div",ee,[d(D,{variant:"text",color:p.value?"primary":"grey",onClick:o[0]||(o[0]=a=>p.value=!p.value),class:"filter-btn"},{default:y(()=>[d($,{icon:p.value?"tabler-mouse-filled":"tabler-mouse",size:"20",class:"me-2"},null,8,["icon"]),C(" Clicks ")]),_:1},8,["color"]),d(D,{variant:"text",color:l.value?"primary":"grey",onClick:o[1]||(o[1]=a=>l.value=!l.value),class:"filter-btn"},{default:y(()=>[d($,{icon:l.value?"tabler-eye-filled":"tabler-eye",size:"20",class:"me-2"},null,8,["icon"]),C(" Impresiones ")]),_:1},8,["color"])]),x.value?(b(),_("div",ae,[d(U,{indeterminate:"",color:"primary"}),te])):(b(),_("div",se,[u.value.series.length>0?(b(),W(H(Q),{key:0,options:u.value.options,series:u.value.series,height:350,width:"100%"},null,8,["options","series"])):(b(),_("div",oe," No hay datos disponibles para el per\xEDodo seleccionado "))]))]))}},ie=O(ne,[["__scopeId","data-v-4fb65fac"]]);export{ie as default};
