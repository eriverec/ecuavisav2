import{M as R,cy as E,r as A,o as c,x as m,a as s,w as t,q as u,f as k,g as C,b2 as w,h as y,n as I,c as D,aM as T,t as p,a3 as _,aW as O,b as o,F as U,C as x,p as h,b0 as j,e as v,b7 as F,b8 as L,b9 as B,ba as P,aR as V,V as S,aQ as z,N as g,a2 as N,Z as H,$ as q,a0 as J,a1 as M,bc as W}from"./index.88d3c7f5.js";import{P as Q}from"./papaparse.min.b6588840.js";import{V as Z}from"./VAlert.3e8ed100.js";import{V as G}from"./VFileInput.692026a8.js";E();A("tab-detalles");const K={setup(){return{id:E().params.id}},data(){return{datos:[],files_csv:[],isFlatSnackRespUserAddAndDelete:!1,isFlatSnackRespUserDelete:!1,isLoadingDialogUser:!1,isLoadingContent:!1,files_csv_mensaje:"",usuarios_traidos_del_csv:[],files_loading:!1,isDialogVisibleDelete:!1,searchQuery:"",dataUsers:[],isDialogSearchUser:!1,csvData:[],csvHeaders:[],switchOnDisabled:!1,disabledBtnDialog:!1,suggestion:{_id:"",campaignTitle:"",statusCampaign:!0,urls:{},criterial:{country:"",city:0},type:"",position:"",created_at:"",userId:[]},currentTab:"tab-detalles",currentPage:1,usersPerPage:10,labelError:{mensaje:"",visible:!1},currentUsers:"",timeoutId:null,timeoutId_2:null,cargandoData:!1,usuariosSearch:[],filter:"",userIdSelected:0}},watch:{},async mounted(){await this.obtenerDetalles();const i=this.suggestion.userId;this.usuariosSearch=i,console.log(i.length)},computed:{totalPages(){return Math.ceil(this.usuariosSearch.length/this.usersPerPage)},currentUsers(){const i=(this.currentPage-1)*this.usersPerPage,a=i+this.usersPerPage;return this.usuariosSearch.slice(i,a)},filteredUsers(){},filteredDataUsers(){return this.dataUsers}},methods:{async add_user(){this.isDialogSearchUser=!0,this.isLoadingDialogUser=!0,await this.obtenerDataUsers(),this.isLoadingDialogUser=!1},async resolveUsuario(i){var a=new Headers;const n=this.id;a.append("Content-Type","application/json");var r={method:"POST",headers:a,body:JSON.stringify({userId:i.wylexId}),redirect:"follow"};this.isLoadingDialogUser=!0;var e=await fetch(`https://ads-service.vercel.app/campaign/add-user/${n}`,r);const d=await e.json();await this.obtenerDetalles(),this.isLoadingDialogUser=!1,this.isDialogSearchUser=!1,d.resp&&(this.isFlatSnackRespUserAddAndDelete=!0)},handleInput(i){clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.filtrarUsuariosUser(i.target.value)},1e3)},async filtrarUsuariosUser(i){try{this.isLoadingDialogUser=!0;const n=await(await fetch(`https://ads-service.vercel.app/busqueda/user/?s=${encodeURIComponent(i)}`)).json();this.isLoadingDialogUser=!1,n.resp?(this.dataUsers=n.data,this.labelError.visible=!1):(this.labelError.mensaje=n.error,this.labelError.visible=!0)}catch(a){console.error(a)}},eliminarRegistro(i){this.id,this.userIdSelected=i,this.isDialogVisibleDelete=!0},async eliminarRegistroDialog(){this.disabledBtnDialog=!0;const i=this.id,a=this.userIdSelected;var n=new Headers;n.append("Content-Type","application/json");var r=JSON.stringify({userId:a}),e={method:"DELETE",headers:n,body:r,redirect:"follow"},d=await fetch(`https://ads-service.vercel.app/campaign/delete-user/${i}`,e);if((await d.json()).resp){await this.obtenerDetalles(),this.isFlatSnackRespUserDelete=!0,this.isDialogVisibleDelete=!1;const l=this.suggestion.userId;this.usuariosSearch=l}else alert("Usuario no eliminado"),this.isDialogVisibleDelete=!1;this.disabledBtnDialog=!1},filtrarUsuarios(){const i=this.suggestion.userId,a=this.filter.toLowerCase();clearTimeout(this.timeoutId_2),this.timeoutId_2=setTimeout(()=>{const n=i.filter(r=>`${r.firstname} ${r.last_name}`.toLowerCase().includes(a)?!0:Object.keys(r).some(d=>d!=="wylexId"&&r[d].toLowerCase().includes(a)));this.usuariosSearch=n||i},1e3)},dividirArray(i,a=500){const n=[];for(let r=0;r<i.length;r+=a){const e=i.slice(r,r+a);n.push(e)}return n},async handleSwitchChange(i){this.switchOnDisabled=!0;var a={status:this.suggestion.statusCampaign},n=new Headers;n.append("Content-Type","application/json");var r={method:"POST",headers:n,body:JSON.stringify(a),redirect:"follow"},e=await fetch(`https://ads-service.vercel.app/campaign/update/status/${this.suggestion._id}`,r);const d=await e.json();d.resp||(alert("Un error se present\xF3: "+d.error),this.suggestion.statusCampaign=!this.suggestion.statusCampaign),this.switchOnDisabled=!1},async obtenerDataUsers(){const a=await(await fetch("https://ads-service.vercel.app/busqueda/user/")).json();this.dataUsers=a.data},async getDetallesCampaign(i={}){const{limit:a=2e4,page:n=1}=i;return(await(await fetch(`https://ads-service.vercel.app/campaign/${this.id}/user/?limit=${a}&page=${n}`)).json())[0]},async obtenerDetalles(){this.isLoadingContent=!0,this.cargandoData=!0;let i=1,a=2e4,n=[];for(;;){const r=await this.getDetallesCampaign({limit:a,page:i});if(r.userId.length===0)break;i==1?n.push(r):n[0].userId.push(...r.userId),this.suggestion=n[0],this.isLoadingContent=!1,i+=1}this.cargandoData=!1},exportToCSV(){let i="data:text/csv;charset=utf-8,";i+=[["id","firstname","last_name","email"].join(","),...this.suggestion.userId.map(r=>[r.wylexId,r.firstname,r.last_name,r.email].join(","))].join(`
`);const a=encodeURI(i),n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download","usuarios.csv"),document.body.appendChild(n),n.click()},async handleUpdateUserCSV(i,a){var n={users:a},r=new Headers;r.append("Content-Type","application/json");var e={method:"POST",headers:r,body:JSON.stringify(n),redirect:"follow"},d=await fetch(`https://ads-service.vercel.app/campaign/users/update/${this.suggestion._id}/${i}`,e);return!!(await d.json()).resp},async handleFileChange(i){const a=i.target.files[0];a&&(a.name.endsWith(".csv")?(this.files_loading=!0,Q.parse(a,{header:!0,dynamicTyping:!0,complete:async n=>{this.csvData=n.data,this.csvHeaders=n.meta.fields;var r=[];for(var e in this.csvData){if(!this.csvData[e].hasOwnProperty("id"))return alert("Error al subir el archivo, no tiene un formato v\xE1lido."),!1;r.push(this.csvData[e].id)}if(this.usuarios_traidos_del_csv=this.dividirArray(r),r.length>3e4)return alert("Error al subir el archivo, la cantidad de usuarios no debe pasar de 30 mil."),!1;var d=0;for(var e in this.usuarios_traidos_del_csv){const f=this.usuarios_traidos_del_csv[e];d+=f.length,this.files_csv_mensaje=`${d} de ${r.length}`;var b=await this.handleUpdateUserCSV(e,f);if(!b){alert("Error al actualizar. Porfavor subir de nuevo el archivo.");break}}this.files_loading=!1,this.files_csv=[],this.obtenerDetalles()}})):alert("Por favor, selecciona un archivo CSV."))}}},X=o("br",null,null,-1),Y=o("thead",null,[o("tr",null,[o("th",{scope:"col"},"Usuario"),o("th",{scope:"col"},"Correo"),o("th",{scope:"col"},"Agregar")])],-1),$={class:"text-medium-emphasis"},ee={class:"text-medium-emphasis"},se={key:1},ae=o("td",{colspan:"3"},"No hay datos",-1),te=[ae],ie={key:0},le={class:"d-flex flex-wrap py-4 gap-4 align-items-center",style:{"justify-content":"space-between"}},re={class:"me-auto pe-4"},oe={class:"d-flex align-center mb-6"},ne={class:"ms-3"},de={class:"d-flex align-center mb-0"},ue={key:0,class:"ms-3"},ce={key:1,class:"ms-3"},pe={class:"d-flex align-center mb-6 mt-6"},ge={class:"ms-3"},me={class:"d-flex align-center mb-0"},he={class:"ms-3"},fe={class:"membership-pricing d-flex flex-column py-14"},_e={style:{width:"100%"},class:"pr-4"},be=o("small",{class:"py-2",style:{"font-size":"10px",color:"#000","text-align":"right",width:"100%",display:"block"}},"M\xE1ximo de usuarios permitidos 30000",-1),ve={key:0},ye={style:{color:"#000","text-align":"left",width:"100%"}},De={style:{display:"block","text-align":"left","max-width":"300px"}},Ve=o("br",null,null,-1),Ce=o("small",{style:{"text-align":"left","line-height":"1.2",display:"block","margin-top":"10px"}},"Los usuarios incluidos en este archivo de importaci\xF3n deben estar registrados en el sitio web.",-1),we={class:""},Ue={class:"d-flex gap-3 flex-wrap"},xe={class:"text-xs text-disabled"},Se={class:"espacio-right-2"};function ke(i,a,n,r,e,d){const b=W;return c(),m("section",null,[s(k,{modelValue:e.isFlatSnackRespUserAddAndDelete,"onUpdate:modelValue":a[0]||(a[0]=l=>e.isFlatSnackRespUserAddAndDelete=l),location:"bottom start",variant:"flat",color:"success"},{default:t(()=>[u(" Usuario agregado. ")]),_:1},8,["modelValue"]),s(k,{modelValue:e.isFlatSnackRespUserDelete,"onUpdate:modelValue":a[1]||(a[1]=l=>e.isFlatSnackRespUserDelete=l),location:"bottom start",variant:"flat",color:"success"},{default:t(()=>[u(" Usuario eliminado. ")]),_:1},8,["modelValue"]),s(j,{modelValue:e.isDialogSearchUser,"onUpdate:modelValue":a[3]||(a[3]=l=>e.isDialogSearchUser=l),persistent:"",class:"v-dialog-lg"},{default:t(()=>[s(b,{onClick:a[2]||(a[2]=l=>e.isDialogSearchUser=!e.isDialogSearchUser)}),s(C,{title:"Lista de usuarios"},{default:t(()=>[s(w,{class:"pl-6 mb-3"},{default:t(()=>[u(" Solo se obtendr\xE1 los 20 primeros registros de acuerdo a la b\xFAsqueda. ")]),_:1}),s(y,null,{default:t(()=>[s(I,{disabled:e.isLoadingDialogUser,"append-inner-icon":"tabler-user-search",type:"text",onInput:d.handleInput,label:"Buscar por correo, tel\xE9fono o nombre",placeholder:"Buscar usuarios"},null,8,["disabled","onInput"]),e.labelError.visible?(c(),D(T,{key:0,color:"error",class:"mt-2"},{default:t(()=>[u(" Error: "+p(e.labelError.mensaje),1)]),_:1})):_("",!0),X,s(O,{style:{width:"100%"},class:"text-no-wrap tableNavegacion mb-5",hover:"true"},{default:t(()=>[Y,o("tbody",null,[e.dataUsers.length>0?(c(!0),m(U,{key:0},x(d.filteredDataUsers,l=>(c(),m("tr",{key:l.userId,class:""},[o("td",null,p((l.last_name+" "+l.first_name).length>25?(l.last_name+" "+l.first_name).substring(0,25)+"...":l.last_name+" "+l.first_name),1),o("td",$,p(l.email),1),o("td",ee,[s(h,{disabled:e.isLoadingDialogUser,class:"mt-4",color:"success",onClick:f=>d.resolveUsuario(l),icon:"mdi-plus-circle-outline",variant:"text"},null,8,["disabled","onClick"])])]))),128)):(c(),m("tr",se,te))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(j,{modelValue:e.isDialogVisibleDelete,"onUpdate:modelValue":a[6]||(a[6]=l=>e.isDialogVisibleDelete=l),persistent:"",class:"v-dialog-sm"},{default:t(()=>[s(b,{onClick:a[4]||(a[4]=l=>e.isDialogVisibleDelete=!e.isDialogVisibleDelete)}),s(C,{title:"\xBFDesea eliminar el usuario #"+e.userIdSelected+"?"},{default:t(()=>[s(y,null,{default:t(()=>[u(" Eliminar\xE1s el usuario del listado para esta campa\xF1a ")]),_:1}),s(y,{class:"d-flex justify-end gap-3 flex-wrap"},{default:t(()=>[s(h,{disabled:e.disabledBtnDialog,color:"secondary",variant:"tonal",onClick:a[5]||(a[5]=l=>e.isDialogVisibleDelete=!1)},{default:t(()=>[u(" No, cerrar ")]),_:1},8,["disabled"]),s(h,{disabled:e.disabledBtnDialog,onClick:d.eliminarRegistroDialog},{default:t(()=>[u(" Si, eliminar ")]),_:1},8,["disabled","onClick"])]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue"]),s(S,null,{default:t(()=>[s(v,{class:"mt-6",cols:"12",md:"12",lg:"12"},{default:t(()=>[s(F,{modelValue:e.currentTab,"onUpdate:modelValue":a[7]||(a[7]=l=>e.currentTab=l),class:"v-tabs-pill"},{default:t(()=>[s(L,{value:"tab-detalles"},{default:t(()=>[u("Detalles")]),_:1}),s(L,{value:"tab-usuarios"},{default:t(()=>[u("Usuarios")]),_:1})]),_:1},8,["modelValue"]),s(C,{class:"mt-5"},{default:t(()=>[s(y,null,{default:t(()=>[e.isLoadingContent?(c(),m("div",ie,"Cargando datos, espere...")):_("",!0),e.isLoadingContent?_("",!0):(c(),D(B,{key:1,modelValue:e.currentTab,"onUpdate:modelValue":a[12]||(a[12]=l=>e.currentTab=l)},{default:t(()=>[s(P,{value:"tab-detalles"},{default:t(()=>[o("div",le,[o("div",null,[s(V,null,{default:t(()=>[u("Informaci\xF3n sobre: "),o("b",null,'"'+p(e.suggestion.campaignTitle)+'"',1)]),_:1}),s(w,null,{default:t(()=>[u(" A continuaci\xF3n encontrar\xE1s detalles sobre la campa\xF1a ")]),_:1})])]),s(v,{md:"6",lg:"12",cols:"12"},{default:t(()=>[s(Z,{color:"success",variant:"tonal"},{default:t(()=>[s(S,{"no-gutters":""},{default:t(()=>[s(v,{cols:"12",sm:"6",md:"12",lg:"6",order:"2","order-lg":"1"},{default:t(()=>[s(z,null,{default:t(()=>[s(V,null,{default:t(()=>[u(p(e.suggestion.campaignTitle),1)]),_:1})]),_:1}),s(y,{class:"d-flex justify-center"},{default:t(()=>[o("div",re,[o("p",oe,[s(g,{color:"primary",icon:"mdi-map-marker",size:"22"}),o("span",ne,p(e.suggestion.criterial.country),1)]),o("p",de,[s(g,{color:"primary",icon:"tabler-user",size:"22"}),e.cargandoData?_("",!0):(c(),m("span",ue,p(e.suggestion.userId.length)+" usuarios",1)),e.cargandoData?(c(),m("span",ce,"Cargando data...")):_("",!0)]),o("p",pe,[s(g,{color:"primary",icon:"mdi-page-layout-header-footer",size:"22"}),o("span",ge,"Posici\xF3n: "+p(e.suggestion.position),1)]),o("p",me,[s(g,{color:"primary",icon:"mdi-calendar-month-outline",size:"22"}),o("span",he,p(e.suggestion.created_at),1)]),s(h,{class:"mt-4",color:"success",onClick:d.exportToCSV},{default:t(()=>[u("Exportar usuarios"),s(g,{end:"",icon:"tabler-download"})]),_:1},8,["onClick"])]),i.$vuetify.display.smAndUp?(c(),D(N,{key:0,vertical:"",inset:""})):_("",!0)]),_:1})]),_:1}),s(v,{cols:"12",sm:"6",md:"12",lg:"6",order:"2","order-lg":"2",class:"member-pricing-bg text-center"},{default:t(()=>[o("div",fe,[s(V,{style:{"text-align":"left"}},{default:t(()=>[u("Subir CSV:")]),_:1}),o("div",_e,[s(G,{modelValue:e.files_csv,"onUpdate:modelValue":a[8]||(a[8]=l=>e.files_csv=l),loading:e.files_loading,disabled:e.files_loading,accept:".csv",placeholder:"Subir tu archivo CSV de usuarios",label:"Subir tu archivo CSV de usuarios","prepend-icon":"tabler-paperclip",onChange:d.handleFileChange},{selection:t(({fileNames:l})=>[(c(!0),m(U,null,x(l,f=>(c(),D(T,{key:f,label:"",size:"small",variant:"outlined",color:"primary",class:"me-2"},{default:t(()=>[u(p(f),1)]),_:2},1024))),128))]),_:1},8,["modelValue","loading","disabled","onChange"]),be,e.files_loading?(c(),m("p",ve,[o("small",ye,[u(" Subiendo usuarios, "+p(e.files_csv_mensaje)+" ",1),s(g,{"x-large":"",class:"rotate"},{default:t(()=>[u(" mdi-loading ")]),_:1})])])):_("",!0),o("div",De,[s(h,{class:"mt-4",color:"success",href:"https://estadisticas.ecuavisa.com/sites/gestor/Recursos/usuarios-ejemplo.csv",target:"_blank"},{default:t(()=>[u("Ver ejemplo de importaci\xF3n"),s(g,{end:"",icon:"tabler-download"})]),_:1}),Ve,Ce])])])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(P,{value:"tab-usuarios"},{default:t(()=>[s(V,{class:"px-0"},{default:t(()=>[u('Esta es la lista de usuarios de la campa\xF1a "'+p(e.suggestion.campaignTitle)+'":',1)]),_:1}),s(w),s(S,{justify:"space-between",class:"my-4"},{default:t(()=>[s(v,{cols:"3"},{default:t(()=>[o("div",we,[s(I,{"append-inner-icon":"tabler-user-search",onInput:d.filtrarUsuarios,modelValue:e.filter,"onUpdate:modelValue":a[9]||(a[9]=l=>e.filter=l),label:"Buscar usuarios dentro del listado"},null,8,["onInput","modelValue"])])]),_:1}),s(v,{cols:"auto"},{default:t(()=>[o("div",Ue,[s(h,{color:"info",onClick:d.exportToCSV},{default:t(()=>[u("Descargar Usuarios"),s(g,{end:"",icon:"tabler-download"})]),_:1},8,["onClick"]),s(h,{color:"success",onClick:d.add_user},{default:t(()=>[u("A\xF1adir usuarios"),s(g,{end:"",icon:"mdi-account-plus"})]),_:1},8,["onClick"])])]),_:1})]),_:1}),s(H,{lines:"two"},{default:t(()=>[(c(!0),m(U,null,x(d.currentUsers,(l,f)=>(c(),D(q,{key:f,border:""},{append:t(()=>[o("div",Se,[s(h,{icon:"",size:"x-small",color:"error",variant:"text",onClick:Ie=>d.eliminarRegistro(l.wylexId)},{default:t(()=>[s(g,{size:"22",icon:"tabler-trash"})]),_:2},1032,["onClick"])])]),default:t(()=>[s(J,null,{default:t(()=>[o("span",null,p(l.firstname)+" "+p(l.last_name),1)]),_:2},1024),s(M,{class:"mt-1",color:"info"},{default:t(()=>[o("span",xe," Correo: "+p(l.email),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}),s(h,{variant:"tonal",onClick:a[10]||(a[10]=l=>e.currentPage--),disabled:e.currentPage<=1,size:"small",color:"primary"},{default:t(()=>[s(g,{start:"",icon:"tabler-arrow-left"}),u(" Anterior ")]),_:1},8,["disabled"]),s(h,{variant:"tonal",onClick:a[11]||(a[11]=l=>e.currentPage++),disabled:e.currentPage>=d.totalPages,size:"small",color:"primary",class:"ma-3"},{default:t(()=>[u(" Siguiente "),s(g,{end:"",icon:"tabler-arrow-right"})]),_:1},8,["disabled"])]),_:1})]),_:1},8,["modelValue"]))]),_:1})]),_:1})]),_:1})]),_:1})])}const Ee=R(K,[["render",ke]]);export{Ee as default};
