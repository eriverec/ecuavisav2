<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Script para obtener audio desde api</title>
</head>

<body>
  <button onclick="obtenerAudios()">Obtener audios</button>
  <audio id="audioPlayer" controls></audio>
  <script>
    async function obtenerAudios() {
      // var getIdArticle = "5134589";
      // var getIdArticle = "5168524";
      // var getIdArticle = "5154428";
      // var getIdArticle = ITER.CONTEXT.articleId;
      // Realizar un primer fetch para obtener tamanioTotal
      const respTotal = await fetch('https://text-to-audio-mu.vercel.app/audio/base64?idArticle=5251941');
      const dataTotal = await respTotal.json();
      const tamanioTotal = dataTotal.tamanioTotal;
      // console.log(tamanioTotal);

      // Configurar audio tag para reproducir el primer audio
      let i = 0;
      const audioPlayer = document.getElementById("audioPlayer");
      const url = `https://text-to-audio-mu.vercel.app/audio/base64?idArticle=5251941&part=${i}`;
      const respPart = await fetch(url);
      const dataPart = await respPart.json();
      audioPlayer.src = "data:audio/mp3;base64," + dataPart.base64;
      audioPlayer.play();

      // Actualizar audio tag cuando termina la reproducci√≥n del audio actual
      let timeoutId = null;
      audioPlayer.onended = async function () {
        i++;
        if (i <= tamanioTotal) {
          const nextUrl = `https://text-to-audio-mu.vercel.app/audio/base64?idArticle=5251941&part=${i}`;
          const nextRespPart = await fetch(nextUrl);
          const nextDataPart = await nextRespPart.json();

          // Iniciar la carga de la siguiente parte 5 segundos antes de que finalice el audio actual
          timeoutId = setTimeout(() => {
            audioPlayer.src = "data:audio/mp3;base64," + nextDataPart.base64;
            audioPlayer.play();
          }, audioPlayer.duration - 5 * 1000);
        }
      }

      // Cancelar temporizador si el usuario decide avanzar manualmente al siguiente audio
      audioPlayer.onseeking = function () {
        clearTimeout(timeoutId);
      }
    }
  </script>
</body>

</html>